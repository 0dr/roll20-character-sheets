<!-- Hidden Inputs -->
<input type="hidden" name="attr_weaponEncumbrance" value="0" />
<input type="hidden" name="attr_attackBonus" value="0" />
<input type="hidden" name="attr_damageBonus" value="0" />

<div class="sheet-container">
  <input
    type="radio"
    name="attr_maintab"
    class="sheet-maintab sheet-character"
    value="1"
    title="Personagem"
    checked="checked"
  /><span class="sheet-maintab sheet-character"><h5>Personagem</h5></span>
  <input
    type="radio"
    name="attr_maintab"
    class="sheet-maintab sheet-spells"
    value="6"
    title="Magias"
  /><span class="sheet-maintab sheet-spells"><h5>Magias</h5></span>
  <input
    type="radio"
    name="attr_maintab"
    class="sheet-maintab sheet-equipment"
    value="2"
    title="Equipamento"
  /><span class="sheet-maintab sheet-equipment"><h5>Equipamento</h5></span>
  <input
    type="radio"
    name="attr_maintab"
    class="sheet-maintab sheet-retainers"
    value="4"
    title="Auxiliares"
  /><span class="sheet-maintab sheet-retainers"><h5>Auxiliares</h5></span>
  <input
    type="radio"
    name="attr_maintab"
    class="sheet-maintab sheet-notes"
    value="5"
    title="Notas"
  /><span class="sheet-maintab sheet-notes"><h5>Notas</h5></span>
  <div class="sheet-maintab-content sheet-character">
    <!-- Cabeçalho -->
    <div class="sheet-logo-and-header">
      <div class="sheet-image-container">
        <img src="https://via.placeholder.com/150" alt="Descrição da Imagem" class="sheet-image" />
      </div>
      <div class="sheet-header">
        <div class="header-line">
          <label for="attr_name">NOME</label>
          <input type="text" name="attr_name" />
        </div>
        <div class="header-line">
          <label for="attr_title">TÍTULO</label>
          <input type="text" name="attr_title" />
          <label for="attr_class">CLASSE</label>
          <input type="text" name="attr_class" />
        </div>
        <div class="header-line">
          <label for="attr_alignment">ALINHAMENTO</label>
          <input type="text" name="attr_alignment" />
          <label for="attr_level">NÍVEL</label>
          <input type="text" name="attr_level" />
        </div>
        <div class="header-line">
          <label for="attr_xp">XP</label>
          <input type="text" name="attr_xp" />
          <label for="attr_xpBonus">XP (+%)</label>
          <input type="text" name="attr_xpBonus" />
          <label for="attr_xpTarget">XP (META)</label>
          <input type="text" name="attr_xpTarget" />
        </div>
      </div>
    </div>
    <!-- Atributos, Salvaguardas e Defesas-->
    <div class="sheet-attributes-and-saves">
      <!-- Atributos -->
      <div class="sheet-attributes">
        <h3>Atributos</h3>
        <div class="sheet-attributes-container">
          <div class="attribute-column-1">
            <label for="attr_str">FOR</label>
            <label for="attr_int">INT</label>
            <label for="attr_wis">SAB</label>
            <label for="attr_dex">DES</label>
            <label for="attr_con">CON</label>
            <label for="attr_cha">CAR</label>
          </div>
          <div class="attribute-column-2">
            <input type="text" name="attr_str" class="attribute-input" />
            <input type="text" name="attr_int" class="attribute-input" />
            <input type="text" name="attr_wis" class="attribute-input" />
            <input type="text" name="attr_dex" class="attribute-input" />
            <input type="text" name="attr_con" class="attribute-input" />
            <input type="text" name="attr_cha" class="attribute-input" />
          </div>
          <div class="attribute-column-3">
            <input
              readonly
              id="ability-strength-modifier"
              name="attr_strMod"
              value="0"
            />
            <input
              readonly
              id="ability-intelligence-modifier"
              name="attr_intMod"
              value="0"
            />
            <input
              readonly
              id="ability-wisdom-modifier"
              name="attr_wisMod"
              value="0"
            />
            <input
              readonly
              id="ability-dexterity-modifier"
              name="attr_dexMod"
              value="0"
            />
            <input
              readonly
              id="ability-constitution-modifier"
              name="attr_conMod"
              value="0"
            />
            <input
              readonly
              id="ability-charisma-modifier"
              name="attr_chaMod"
              value="0"
            />
          </div>
        </div>
      </div>
      <!-- Salvaguardas -->
      <div class="sheet-saves">
        <h3>SALVAGUARDAS</h3>
        <div class="sheet-saves-container">
          <div class="saves-line">
            <div class="save-wrapper">
              <input type="text" name="attr_saveDeath" class="rounded-input" />
            </div>
            <div class="saves-input-container">
              <label for="attr_saveDeath">
                <button
                  type="roll"
                  name="attr_rollSaveDeath"
                  value="&{template:greater} {{roll=@{character_name} salvaguarda contra Morte}} {{result=[[ [[1d20]]>@{saveDeath} ]]}} {{check=[[@{saveDeath}]]}}"
                  class="save-button"
                >
                  MORTE
                </button></label
              >
            </div>
          </div>
          <div class="saves-line">
            <div class="save-wrapper">
              <input
                type="text"
                name="attr_saveContact"
                class="rounded-input"
              />
            </div>
            <div class="saves-input-container">
              <label for="attr_saveContact">
                <button
                  type="roll"
                  name="attr_rollSaveContact"
                  value="&{template:greater} {{roll=@{character_name} salvaguarda contra Contato}} {{result=[[ [[1d20]]>@{saveContact} ]]}} {{check=[[@{saveContact}]]}}"
                  class="save-button"
                >
                  CONTATO
                </button></label
              >
            </div>
          </div>
          <div class="saves-line">
            <div class="save-wrapper">
              <input
                type="text"
                name="attr_saveParalysis"
                class="rounded-input"
              />
            </div>
            <div class="saves-input-container">
              <label for="attr_saveParalysis">
                <button
                  type="roll"
                  name="attr_rollSaveParalysis"
                  value="&{template:greater} {{roll=@{character_name} salvaguarda contra Paralisia}} {{result=[[ [[1d20]]>@{saveParalysis} ]]}} {{check=[[@{saveParalysis}]]}}"
                  class="save-button"
                >
                  PARALISIA
                </button></label
              >
            </div>
          </div>
          <div class="saves-line">
            <div class="save-wrapper">
              <input
                type="text"
                name="attr_saveIrruption"
                class="rounded-input"
              />
            </div>
            <div class="saves-input-container">
              <label for="attr_saveIrruption">
                <button
                  type="roll"
                  name="attr_rollSaveIrruption"
                  value="&{template:greater} {{roll=@{character_name} salvaguarda contra Irrupção}} {{result=[[ [[1d20]]>@{saveIrruption} ]]}} {{check=[[@{saveIrruption}]]}}"
                  class="save-button"
                >
                  IRRUPÇÃO
                </button></label
              >
            </div>
          </div>
          <div class="saves-line">
            <div class="save-wrapper">
              <input type="text" name="attr_saveSpell" class="rounded-input" />
            </div>
            <div class="saves-input-container">
              <label for="attr_saveSpell">
                <button
                  type="roll"
                  name="attr_rollSaveSpell"
                  value="&{template:greater} {{roll=@{character_name} salvaguarda contra Feitiço}} {{result=[[ [[1d20]]>@{saveSpell} ]]}} {{check=[[@{saveSpell}]]}}"
                  class="save-button"
                >
                  FEITIÇO
                </button></label
              >
            </div>
          </div>
        </div>
      </div>
      <!-- Defesas -->
      <div class="sheet-defenses-and-movement">
        <div class="sheet-defenses">
          <div class="defense-line">
            <label for="attr_ac">CA</label>
            <input readonly type="text" name="attr_ac" />
          </div>
          <div class="defense-line">
            <label for="attr_pvMax">PV MÁXIMO</label>
            <input type="text" name="attr_pvMax" />
          </div>
          <div class="defense-line">
            <label for="attr_pvCurrent">PV ATUAL</label>
            <input type="text" name="attr_pvCurrent" />
          </div>
        </div>
        <div class="sheet-movement">
          <h3>DESLOCAMENTO</h3>
          <div class="movement-line">
            <label for="attr_moveBase">BASE</label>
            <input type="text" name="attr_moveBase" />
          </div>
          <div class="movement-line">
            <label for="attr_moveExplorationOrRunning"
              >EXPLORAÇÃO/CORRIDA</label
            >
            <input type="text" name="attr_movExplorationOrRunning" />
          </div>
          <div class="movement-line">
            <label for="attr_moveTravel">VIAGEM</label>
            <input type="text" name="attr_moveTravel" />
          </div>
        </div>
      </div>
    </div>
    <div class="sheet-languages-and-thac0">
      <!-- Idiomas e TACO-->
      <div class="sheet-languages">
        <h3>IDIOMAS</h3>
        <div class="languages-container">
          <textarea name="attr_languages"></textarea>
          <div class="literate-checkbox">
            <label for="attr_literate">LETRADO</label>
            <input type="checkbox" name="attr_literate" />
          </div>
        </div>
      </div>
      <!-- TACO e Bônus de Ataque -->
      <div class="sheet-taco-ba">
        <div class="taco-line">
          <label for="attr_thac0">TACO</label>
          <input type="text" name="attr_thac0" />
          <label for="attr_ba">BÔNUS DE ATAQUE</label>
          <input type="text" name="attr_ba" />
        </div>
        <div class="taco-grid">
          <label>0</label>
          <label>1</label>
          <label>2</label>
          <label>3</label>
          <label>4</label>
          <label>5</label>
          <label>6</label>
          <label>7</label>
          <label>8</label>
          <label>9</label>
          <input readonly type="text" name="attr_attackMatrix0"/>
          <input readonly type="text" name="attr_attackMatrix1"/>
          <input readonly type="text" name="attr_attackMatrix2"/>
          <input readonly type="text" name="attr_attackMatrix3"/>
          <input readonly type="text" name="attr_attackMatrix4"/>
          <input readonly type="text" name="attr_attackMatrix5"/>
          <input readonly type="text" name="attr_attackMatrix6"/>
          <input readonly type="text" name="attr_attackMatrix7"/>
          <input readonly type="text" name="attr_attackMatrix8"/>
          <input readonly type="text" name="attr_attackMatrix9"/>
        </div>
        <div class="game-armor-class-option">
          <label class="retainer-training-and-description">
            <span>Opção de CA no jogo</span>
            <select id="ac-option" name="attr_armorClassType">
              <option value="aac">Ascendente</option>
              <option value="dac" selected>Descendente</option>
            </select>
          </label>
        </div>
      </div>
    </div>
    <!-- Armas -->
    <div class="sheet-weapon">
      <h3>ARMAS</h3>
      <div>
        <fieldset class="repeating_weapons">
          <div class="weapon-container">
            <div class="weapons-grid">
              <span></span>
              <span>Nome</span>
              <span>Tipo de Ataque</span>
              <span>+Atq</span>
              <span>Dado de Dano</span>
              <span>+Dano</span>
              <span>Peso</span>
            </div>
            <div class="weapons-grid">
              <div>
                <button
                  type="roll"
                  name="aacAttackRoll"
                  value="&{template:simple} {{roll=@{character_name} ataca com @{weaponName}}} {{ataque=[[1d20+@{dexMod}+@{weaponAttackBonus}+@{attackBonus}]]}} {{dano=[[@{weaponDamageDie}+@{weaponDamageBonus}+@{damageBonus}]]}} {{description=@{weaponDescription}}}"
                ></button>
              </div>
              <!-- Outros Campos -->
              <input type="text" name="attr_weaponName" />
              <select name="attr_attackType">
                <option value="melee">Corpo a Corpo</option>
                <option value="ranged">A Distância</option>
              </select>
              <input type="number" name="attr_weaponAttackBonus" value="0" />
              <input
                type="text"
                name="attr_weaponDamageDie"
                value="1d6"
                class="input-as-number"
              />
              <input type="number" name="attr_weaponDamageBonus" value="0" />
              <input type="number" min="0" name="attr_weaponWeight" value="0" />
            </div>
            <input
              id="weapon-description"
              type="text"
              name="attr_weaponDescription"
              class="weapon-description"
              placeholder="Descrição"
            />
          </div>
        </fieldset>
      </div>
    </div>
  </div>
  <!-- Magias -->
  <div class="sheet-maintab-content sheet-spells">
    <div class="spells-container">
      <div class="spells-per-level">
        <label>
          <span>1</span>
          <input
            type="number"
            min="0"
            name="attr_spellsLevel1Available"
            title="Magias Disponíveis"
            value="0"
          />
          /
          <input
            type="number"
            min="0"
            id="spells-level-1-total"
            name="attr_spellsLevel1Total"
            title="Magias Totais"
            value="0"
          />
        </label>
        <label class="inline-flex">
          <span>2</span>
          <input
            type="number"
            min="0"
            name="attr_spellsLevel2Available"
            title="Magias Disponíveis"
            value="0"
          />
          /
          <input
            type="number"
            min="0"
            id="spells-level-2-total"
            name="attr_spellsLevel2Total"
            title="Magias Totais"
            value="0"
          />
        </label>
        <label class="inline-flex">
          <span>3</span>
          <input
            type="number"
            min="0"
            name="attr_spellsLevel3Available"
            title="Magias Disponíveis"
            value="0"
          />
          /
          <input
            type="number"
            min="0"
            id="spells-level-3-total"
            name="attr_spellsLevel3Total"
            title="Magias Totais"
            value="0"
          />
        </label>
        <label class="inline-flex">
          <span>4</span>
          <input
            type="number"
            min="0"
            name="attr_spellsLevel4Available"
            title="Magias Disponíveis"
            value="0"
          />
          /
          <input
            type="number"
            min="0"
            id="spells-level-4-total"
            name="attr_spellsLevel4Total"
            title="Magias Totais"
            value="0"
          />
        </label>
        <label class="inline-flex">
          <span>5</span>
          <input
            type="number"
            min="0"
            name="attr_spellsLevel5Available"
            title="Magias Disponíveis"
            value="0"
          />
          /
          <input
            type="number"
            min="0"
            id="spells-level-5-total"
            name="attr_spellsLevel5Total"
            title="Magias Totais"
            value="0"
          />
        </label>
      </div>
      <div>
        <div class="spells-grid">
          <span></span>
          <span>Mem.</span>
          <span>Nome</span>
          <span>Círculo</span>
          <span>Descrição</span>
          <span>Rolagem</span>
        </div>
        <fieldset class="repeating_spells">
          <div class="spells-grid">
            <div>
              <button
                type="roll"
                name="spellCast"
                class="roll"
                value="&{template:simple} {{roll=@{character_name} conjura @{spellName}}} {{efeito=[[@{spellEffect}]]}} {{descrição=@{spellDescription}}}"
              ></button>
            </div>
            <input
              type="number"
              min="0"
              name="attr_spellMemorized"
              checked
              title="Memorizadas"
              value="0"
            />
            <input type="text" name="attr_spellName" />
            <input type="number" min="1" name="attr_spellLevel" value="1" />
            <input type="text" name="attr_spellDescription" />
            <input
              type="text"
              class="half-input"
              name="attr_spellEffect"
              value="0"
              placeholder="não apague"
            />
          </div>
        </fieldset>
      </div>
    </div>
  </div>
  <!-- EQUIPAMENTOS -->
  <div class="sheet-maintab-content sheet-equipment">
    <div class="equipment-container">
      <div class="encumbrance">
        <label>carga (cn)</label>
        <label>
          <span>Moedas</span>
          <input
            readonly
            type="number"
            min="0"
            name="attr_coinEncumbrance"
            value="0"
            class="encumbrance-input"
          />
        </label>
        <label>
          <span>Total</span>
          <input
            readonly
            type="number"
            min="0"
            name="attr_TotalEncumbrance"
            value="0"
            class="encumbrance-input"
          />
        </label>
        <label>
          <span>Auxiliares</span>
          <input
            readonly
            type="number"
            min="0"
            name="attr_retainerEncumbrance"
            value="0"
            class="encumbrance-input"
          />
        </label>
        <label>
          <span>Montaria</span>
          <input
            readonly
            type="number"
            min="0"
            name="attr_mountEncumbrance"
            value="0"
            class="encumbrance-input"
          />
        </label>
        <label>
          <span>Carroça</span>
          <input
            readonly
            type="number"
            min="0"
            name="attr_cartEncumbrance"
            value="0"
            class="encumbrance-input"
          />
        </label>
        <label>
          <span>Guardado</span>
          <input
            readonly
            type="number"
            min="0"
            name="attr_StowedEncumbrance"
            value="0"
            class="encumbrance-input"
          />
        </label>
      </div>
      <div class="equip">
        <div class="title-and-encumbrance">
          <h2>Armadura</h2>
          <div>
            <label>cn</label>
            <input
              readonly
              type="number"
              min="0"
              name="attr_armorEncumbrance"
              value="0"
              class="encumbrance-input"
            />
          </div>
        </div>
        <div class="armor-grid">
          <span>Nome</span>
          <span>CA</span>
          <span>Peso</span>
          <span>Equipada?</span>
        </div>
        <fieldset class="repeating_armor">
          <div class="armor-grid">
            <input type="text" name="attr_armorName" />
            <input type="text" name="attr_armorValue" value="0" />
            <input type="number" min="0" name="attr_armorWeight" value="0" />
            <div class="sheet-checkbox">
              <input type="checkbox" name="attr_armorWorn" checked />
            </div>
          </div>
        </fieldset>
      </div>
      <div class="equip">
        <div class="title-and-encumbrance">
          <h2>Itens</h2>
          <div>
            <label>cn</label>
            <input
              readonly
              type="number"
              min="0"
              name="attr_ItemsEncumbrance"
              value="0"
              class="encumbrance-input"
            />
          </div>
        </div>
        <div class="items-grid">
          <span>Qtd</span>
          <span>Nome</span>
          <span>Descrição</span>
          <span>Peso</span>
        </div>
        <fieldset class="repeating_items">
          <div class="items-grid">
            <input type="number" min="0" name="attr_ItemQuantity" value="1" />
            <input type="text" name="attr_ItemName" />
            <input type="text" name="attr_ItemDescription" />
            <input type="number" min="0" name="attr_ItemWeight" value="0" />
          </div>
        </fieldset>
      </div>
      <div class="equip">
        <div class="coins">
          <label>
            <span>PO</span>
            <input
              type="number"
              min="0"
              name="attr_GP"
              title="Peças de Ouro"
              value="0"
            />
          </label>
          <label class="inline-flex">
            <span>PP</span>
            <input
              type="number"
              min="0"
              name="attr_SP"
              title="Peças de Prata"
              value="0"
            />
          </label>
          <label class="inline-flex">
            <span>PC</span>
            <input
              type="number"
              min="0"
              name="attr_CP"
              title="Peças de Bronze"
              value="0"
            />
          </label>
        </div>
      </div>
      <div class="equip">
        <div class="title-and-encumbrance">
          <h2>Itens com Auxiliares</h2>
          <div>
            <label>cn</label>
            <input
              readonly
              type="number"
              min="0"
              name="attr_retainerEncumbrance"
              value="0"
              class="encumbrance-input"
            />
          </div>
        </div>
        <div class="items-grid">
          <span>Qtd</span>
          <span>Nome</span>
          <span>Descrição</span>
          <span>Peso</span>
        </div>
        <fieldset class="repeating_retaineritems">
          <div class="items-grid">
            <input
              type="number"
              min="0"
              name="attr_RetainerItemQuantity"
              value="1"
            />
            <input type="text" name="attr_RetainerItemName" />
            <input type="text" name="attr_RetainerItemDescription" />
            <input
              type="number"
              min="0"
              name="attr_RetainerItemWeight"
              value="0"
            />
          </div>
        </fieldset>
      </div>
      <div class="equip">
        <div class="title-and-encumbrance">
          <h2>Itens na Montaria</h2>
          <div>
            <label>cn</label>
            <input
              readonly
              type="number"
              min="0"
              name="attr_mountEncumbrance"
              value="0"
              class="encumbrance-input"
            />
          </div>
        </div>
        <div class="items-grid">
          <span>Qtd</span>
          <span>Nome</span>
          <span>Descrição</span>
          <span>Peso</span>
        </div>
        <fieldset class="repeating_mountitems">
          <div class="items-grid">
            <input
              type="number"
              min="0"
              name="attr_MountItemQuantity"
              value="1"
            />
            <input type="text" name="attr_MountItemName" />
            <input type="text" name="attr_MountItemDescription" />
            <input
              type="number"
              min="0"
              name="attr_MountItemWeight"
              value="0"
            />
          </div>
        </fieldset>
      </div>
      <div class="equip">
        <div class="title-and-encumbrance">
          <h2>Itens na Carroça</h2>
          <div>
            <label>cn</label>
            <input
              readonly
              type="number"
              min="0"
              name="attr_cartEncumbrance"
              value="0"
              class="encumbrance-input"
            />
          </div>
        </div>
        <div class="items-grid">
          <span>Qtd</span>
          <span>Nome</span>
          <span>Descrição</span>
          <span>Peso</span>
        </div>
        <fieldset class="repeating_cartitems">
          <div class="items-grid">
            <input
              type="number"
              min="0"
              name="attr_CartItemQuantity"
              value="1"
            />
            <input type="text" name="attr_CartItemName" />
            <input type="text" name="attr_CartItemDescription" />
            <input type="number" min="0" name="attr_CartItemWeight" value="0" />
          </div>
        </fieldset>
      </div>
      <div class="equip">
        <div class="title-and-encumbrance">
          <h2>Itens Guardados</h2>
          <div>
            <label>cn</label>
            <input
              readonly
              type="number"
              min="0"
              name="attr_stowedEncumbrance"
              value="0"
              class="encumbrance-input"
            />
          </div>
        </div>
        <div class="items-grid">
          <span>Qtd</span>
          <span>Nome</span>
          <span>Descrição</span>
          <span>Peso</span>
        </div>
        <fieldset class="repeating_stoweditems">
          <div class="items-grid">
            <input
              type="number"
              min="0"
              name="attr_StowedItemQuantity"
              value="1"
            />
            <input type="text" name="attr_StowedItemName" />
            <input type="text" name="attr_StowedItemDescription" />
            <input
              type="number"
              min="0"
              name="attr_StowedItemWeight"
              value="0"
            />
          </div>
        </fieldset>
      </div>
    </div>
  </div>
  <!-- AUXILIARES -->
  <div class="sheet-maintab-content sheet-retainers">
    <div class="retainers-container">
      <fieldset class="repeating_retainer">
        <div class="retainer-info-container">
          <div class="retainers-grid">
            <input type="text" name="attr_retainerName" placeholder="Nome" />
            <input
              type="text"
              min="0"
              name="attr_retainerProfession"
              placeholder="Ofício"
            />
            <!-- <input type="text" name="attr_retainerKind" placeholder="Categoria" /> -->
            <select id="retainer-kind" name="attr_retainerKind">
              <option value="follower" selected>Auxiliar</option>
              <option value="hireling">Profissional</option>
              <option value="mount">Montaria</option>
              <option value="animal">Animal</option>
            </select>
            <select id="retainer-loyalty" name="attr_retainerLoyalty">
              <option value="loyal">Leal</option>
              <option value="notLoyal" selected>Não Leal</option>
            </select>
          </div>
          <div class="retainers-details" name="attr_retainerDetails">
            <div class="retainers-details-first-line">
              <label class="retainers-hd-and-moral">
                <span>DV</span>
                <input type="number" min="0" name="attr_retainerHD" />
              </label>
              <label class="retainers-hd-and-moral">
                <span>ML</span>
                <input type="number" min="0" name="attr_retainerMoral" />
              </label>
              <label class="retainers-hd-and-moral">
                <span>Taco/BA</span>
                <input type="number" min="0" name="attr_retainerTaco" />
              </label>
              <div class="retainer-saves">
                <label>Salvaguardas</label>
                <label>
                  <span>M</span>
                  <input type="number" min="0" name="attr_retainerDeathSave" />
                </label>
                <label>
                  <span>C</span>
                  <input
                    type="number"
                    min="0"
                    name="attr_retainerContactSave"
                  />
                </label>
                <label>
                  <span>P</span>
                  <input
                    type="number"
                    min="0"
                    name="attr_retainerParalysisSave"
                  />
                </label>
                <label>
                  <span>I</span>
                  <input
                    type="number"
                    min="0"
                    name="attr_retainerIrruptionSave"
                  />
                </label>
                <label>
                  <span>F</span>
                  <input type="number" min="0" name="attr_retainerSpellSave" />
                </label>
              </div>
            </div>
            <label class="retainer-training-and-description">
              <span>Treinamento</span>
              <input type="text" name="attr_retainerTraining" />
            </label>
            <label class="retainer-training-and-description">
              <span>Descrição</span>
              <input type="text" name="attr_retainerDescription" />
            </label>
          </div>
        </div>
      </fieldset>
    </div>
  </div>
  <!-- NOTAS -->
  <div class="sheet-maintab-content sheet-notes">
    <textarea name="attr_notes" class="notes"></textarea>
  </div>
</div>
<rolltemplate class="sheet-rolltemplate-simple">
  <div>
    <h3>{{roll}}</h3>
    {{#result}}
    <span class="sheet-template-result-only">{{result}}</span>
    {{/result}}
    {{#allprops() roll result description morale reaction}}
    <div class="sheet-template-row">
      <span class="sheet-template-term">{{key}}:</span>
      <span class="sheet-template-result">{{value}}</span>
    </div>
    {{/allprops() roll result description morale reaction}}
    {{#description}}
    <div class="sheet-template-description">{{description}}</div>
    {{/description}}
    <!-- Attack Specific -->
    {{#attack}} 
    {{#rollWasCrit() attack}}
    <span class="sheet-template-result-only fullcrit">20 natural!</span>
    {{/rollWasCrit() attack}} 
    {{#rollWasFumble() attack}}
    <span class="sheet-template-result-only fullfail">1 natural!</span>
    {{/rollWasFumble() attack}} 
    {{/attack}}
  </div>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-greater">
  <div>
    <h3>{{roll}}</h3>
    <span style="background: white; display: none">{{check}}</span>
    <span style="background: white">{{result}}</span>
    {{#rollLess() result check}}
    <span class="rollresult rollfail">Falha</span>
    {{/rollLess() result check}} {{#rollGreater() result check}}
    <span class="rollresult rollsuccess">Successo</span>
    {{/rollGreater() result check}} {{#rollTotal() result check}}
    <span class="rollresult rollsuccess">Successo</span>
    {{/rollTotal() result check}}
  </div>
</rolltemplate>
<script type="text/worker">
        /* ===== PARAMETERS ==========
        destination = the name of the attribute that stores the total quantity
        section = name of repeating fieldset, without the repeating_
        fields = the name of the attribute field to be summed
            can be a single attribute: 'weight'
            or an array of attributes: ['weight','number','equipped']
        multiplier (optional) = a multiplier to the entire fieldset total. For instance, if summing coins of weight 0.02, might want to multiply the final total by 0.02.
        */
        const repeatingSum = (
          destination,
          section,
          fields,
          { multiplier = 1, callback = Function.prototype }
        ) => {
          if (!Array.isArray(fields)) fields = [fields];
          getSectionIDs(`repeating_${section}`, (idArray) => {
            const attrArray = idArray.reduce(
              (m, id) => [
                ...m,
                ...fields.map((field) => `repeating_${section}_${id}_${field}`),
              ],
              []
            );
            getAttrs(attrArray, (v) => {
              console.log("===== values of v: " + JSON.stringify(v) + " =====");
              // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
              const getValue = (section, id, field) =>
                parseFloat(v[`repeating_${section}_${id}_${field}`]) ||
                (v[`repeating_${section}_${id}_${field}`] === "on" ? 1 : 0);
              const sumTotal = idArray.reduce(
                (total, id) =>
                  total +
                  fields.reduce(
                    (subtotal, field) => subtotal * getValue(section, id, field),
                    1
                  ),
                0
              );
              setAttrs({ [destination]: sumTotal * multiplier }, callback);
            });
          });
        };
        /**
        * Given a value and set of modifiers, return the correct modifiers
        * @param {number} value The value to get modifiers for
        * @param {Array} modifiers Array of arrays or numbers representing modifiers
        * @returns {number|Array} The modifier(s) associated with the value
        */
       function getModifiers(value, modifiers = [-3, -2, -1, 0, 1, 2, 3]) {
         if (value <= 3) {
           return modifiers[0];
         } else if (value >= 4 && value <= 5) {
           return modifiers[1];
         } else if (value >= 6 && value <= 8) {
           return modifiers[2];
         } else if (value >= 9 && value <= 12) {
           return modifiers[3];
         } else if (value >= 13 && value <= 15) {
           return modifiers[4];
         } else if (value >= 16 && value <= 17) {
           return modifiers[5];
         } else {
          return modifiers[6];
         }
       }
       on("sheet:opened change:str", function () {
        getAttrs(["str"], function (values) {
          setAttrs({ strMod: getModifiers(values.str) });
        });
      });
      on("sheet:opened change:int", function () {
        getAttrs(["int"], function (values) {
          setAttrs({ intMod: getModifiers(values.int) });
        });
      });
      on("sheet:opened change:wis", function () {
        getAttrs(["wis"], function (values) {
          const wisMod = getModifiers(values.wis);
          setAttrs({
            wisMod,
            wisdomSaveQuery: (wisMod === 0)
              ? 0
              : "?{" +
                getTranslationByKey("wisdom-save-apply") +
                "|" +
                getTranslationByKey("no") +
                ",0|" +
                getTranslationByKey("yes") +
                ",@{wisMod}}[" +
                getTranslationByKey("wisdom-abbr") +
                "]"
            });
        });
      });
      on("sheet:opened change:dex", function () {
        getAttrs(["dex"], function (values) {
            const dex = parseInt(values.dex) || 0;
            // Calcular o modificador de DEX
            const dexMod = getModifiers(dex);
            // Atualizar os campos dexMod
            setAttrs({
                dexMod: dexMod,
            });
        });
    });
      on("sheet:opened change:con", function () {
        getAttrs(["conMod", "con"], function (values) {
          setAttrs({ conMod: getModifiers(values.con) });
        });
      });
      on("sheet:opened change:cha", function () {
        getAttrs(["cha"], function (values) {
          setAttrs({ chaMod: getModifiers(values.cha) });
        });
      });
        on("sheet:opened change:armorClassType change:ba", function () {
          getAttrs(["armorClassType", "ba"], function (values) {
              const armorClassType = values.armorClassType;
              const ba = parseInt(values.ba) || 0;
              let attackBonus = 0; // Valor padrão para attackBonus
              // Define attackBonus com base no valor de armorClassType
              if (armorClassType === "aac") {
                  attackBonus = ba;
              } else if (armorClassType === "dac") {
                  attackBonus = 0;
              }
              // Atualiza o atributo attackBonus
              setAttrs({
                  attackBonus: attackBonus
              });
          });
      });
      on("sheet:opened change:attackType change:strMod", function () {
        getAttrs(["attackType", "strMod"], function (values) {
            const attackType = values.attackType;
            const strMod = parseInt(values.strMod) || 0;
            let bonusDamage = 0; // Valor padrão
            // Define bonusDamage com base no valor de attackType
            if (attackType === "melee") {
                bonusDamage = strMod;
            } else if (attackType === "ranged") {
                bonusDamage = 0;
            }
            // Atualiza o atributo bonusDamage
            setAttrs({
                bonusDamage: bonusDamage
            });
        });
    });
       // Atualizar weaponEncumbrance com a soma de todos os weaponWeight em repeating_weapons
    on("change:repeating_weapons:weaponWeight remove:repeating_weapons", function () {
        getSectionIDs("repeating_weapons", function (ids) {
            let totalWeight = 0;
            // Iterar por todos os IDs da seção repeating_weapons
            ids.forEach(id => {
                getAttrs([`repeating_weapons_${id}_weaponWeight`], function (values) {
                    const weight = parseInt(values[`repeating_weapons_${id}_weaponWeight`]) || 0;
                    // Adiciona o peso ao total
                    totalWeight += weight;
                    // Atualizar o campo weaponEncumbrance com a soma
                    setAttrs({ weaponEncumbrance: totalWeight });
                });
            });
            // Caso não haja armas, zera o total
            if (ids.length === 0) {
                setAttrs({ weaponEncumbrance: 0 });
            }
        });
    });
      // Atualizar attr_coinEncumbrance quando os campos GP, SP ou CP mudarem
      on("sheet:opened change:GP change:SP change:CP", function () {
          getAttrs(["GP", "SP", "CP"], function (values) {
              const gp = parseInt(values.GP);
              const sp = parseInt(values.SP);
              const cp = parseInt(values.CP);
              // Soma os valores
              const total = gp + sp + cp;
              // Atualiza o campo attr_coinEncumbrance
              setAttrs({ coinEncumbrance: total });
          });
      });

      // Função genérica para calcular encumbrance
      function calculateEncumbrance(fieldsetName, weightField, quantityField, totalField) {
          on(`change:repeating_${fieldsetName}:${weightField} change:repeating_${fieldsetName}:${quantityField} remove:repeating_${fieldsetName}`, function () {
              getSectionIDs(`repeating_${fieldsetName}`, function (ids) {
                  let totalWeight = 0;
                  ids.forEach(id => {
                      getAttrs([`repeating_${fieldsetName}_${id}_${weightField}`, `repeating_${fieldsetName}_${id}_${quantityField}`], function (values) {
                          const weight = parseInt(values[`repeating_${fieldsetName}_${id}_${weightField}`]) || 0;
                          const quantity = parseInt(values[`repeating_${fieldsetName}_${id}_${quantityField}`]) || 0;
                          totalWeight += weight * quantity;
                          setAttrs({ [totalField]: totalWeight });
                      });
                  });
                  if (ids.length === 0) {
                      setAttrs({ [totalField]: 0 });
                  }
              });
          });
      }
      // Chamadas para cada categoria
      calculateEncumbrance("items", "ItemWeight", "ItemQuantity", "ItemsEncumbrance");
      calculateEncumbrance("retaineritems", "RetainerItemWeight", "RetainerItemQuantity", "retainerEncumbrance");
      calculateEncumbrance("mountitems", "MountItemWeight", "MountItemQuantity", "mountEncumbrance");
      calculateEncumbrance("cartitems", "CartItemWeight", "CartItemQuantity", "cartEncumbrance");
      calculateEncumbrance("stoweditems", "StowedItemWeight", "StowedItemQuantity", "stowedEncumbrance");
      // Atualizar TotalEncumbrance com a soma de coinEncumbrance, ItemsEncumbrance, armorEncumbrance e weaponEncumbrance
  on("change:coinEncumbrance change:ItemsEncumbrance change:armorEncumbrance change:weaponEncumbrance", function () {
      // Obter os valores dos campos relevantes
      getAttrs(["coinEncumbrance", "ItemsEncumbrance", "armorEncumbrance", "weaponEncumbrance"], function (values) {
          const coin = parseInt(values.coinEncumbrance) || 0;
          const items = parseInt(values.ItemsEncumbrance) || 0;
          const armor = parseInt(values.armorEncumbrance) || 0;
          const weapons = parseInt(values.weaponEncumbrance) || 0;
          // Soma os valores
          const total = coin + items + armor + weapons;
          // Atualiza o campo TotalEncumbrance
          setAttrs({ TotalEncumbrance: total });
      });
  });

  on("sheet:opened change:thac0", function () {
    getAttrs(["thac0"], function (values) {
        const thac0 = parseInt(values.thac0) || 0;

        // Cria um objeto para armazenar os valores atualizados
        const updates = {};

        // Calcula os valores para cada attackMatrix
        for (let i = 0; i <= 9; i++) {
            updates[`attackMatrix${i}`] = thac0 - i;
        }

        // Atualiza os atributos de attackMatrix
        setAttrs(updates);
    });
});

// Atualizar armorEncumbrance com a soma de todos os armorWeight em repeating_armor
on("change:repeating_armor:armorWeight remove:repeating_armor", function () {
    // Obter todos os valores de armorWeight
    getSectionIDs("repeating_armor", function (ids) {
        let totalWeight = 0;
        // Iterar por todos os IDs da seção repeating_armor
        ids.forEach(id => {
            getAttrs([`repeating_armor_${id}_armorWeight`], function (values) {
                const weight = parseInt(values[`repeating_armor_${id}_armorWeight`]) || 0;
                totalWeight += weight;
                // Atualizar o campo armorEncumbrance quando a soma estiver completa
                setAttrs({ armorEncumbrance: totalWeight });
            });
        });
        // Atualizar imediatamente o campo para o caso de não haver valores
        if (ids.length === 0) {
            setAttrs({ armorEncumbrance: 0 });
        }
    });
});

on("sheet:opened change:armorClassType change:repeating_armor:armorValue change:repeating_armor:armorWorn remove:repeating_armor", function () {
  getAttrs(["armorClassType"], function (values) {
      const armorClassType = values.armorClassType || "aac"; // Default para teste
      console.log("Tipo de Armor Class:", armorClassType);

      // Obter os IDs dos itens no fieldset repeating_armor
      getSectionIDs("repeating_armor", function (ids) {
          console.log("IDs no fieldset repeating_armor:", ids);

          let totalArmorValue = 0;

          // Criar lista de atributos a serem buscados
          const attributesToGet = ids.reduce((acc, id) => {
              acc.push(`repeating_armor_${id}_armorValue`, `repeating_armor_${id}_armorWorn`);
              return acc;
          }, []);

          getAttrs(attributesToGet, function (itemValues) {
              console.log("Valores obtidos dos itens:", itemValues);

              ids.forEach((id) => {
                  const armorValue = parseInt(itemValues[`repeating_armor_${id}_armorValue`]) || 0;
                  const armorWorn = itemValues[`repeating_armor_${id}_armorWorn`] === "on";

                  console.log(itemValues[`repeating_armor_${id}_armorWorn`])

                  console.log(`Item ID: ${id}, armorValue: ${armorValue}, armorWorn: ${armorWorn}`);

                  if (armorWorn) {
                      totalArmorValue += armorValue;
                  }
              });

              // Calcular o valor de AC com base no tipo de Armor Class
              let ac = 0;
              if (armorClassType === "aac") {
                  ac = 10 + totalArmorValue;
              } else if (armorClassType === "dac") {
                  ac = 9 - totalArmorValue;
              }

              console.log("Total Armor Value:", totalArmorValue, "Valor de AC Calculado:", ac);

              // Atualizar o atributo attr_ac
              setAttrs({ ac: ac });
          });
      });
  });
});


</script>