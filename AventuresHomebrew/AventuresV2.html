<input type='hidden' class='sheet-form' name='attr_sheetTab'/>

<div class='sheet'>
   
    <!-- Logo aventures -->
        <div class="sheet-logo-aventures">
            <img src="https://raw.githubusercontent.com/Mihawk59/AventuresV2/main/aventures.png" width="150px"/>
        </div>

        <!-- Informations générales du personnage -->
        <!-- Le système de table grid est utilisé dans cette page -->
        <div class="sheet-block">
            <div class="sheet-head">
                Personnage
            </div>
            <div class="grid-character">
                <div class="grid-character-nom">
                    Nom: <input type="text" class="sheet-input-text" spellcheck="false" name="attr_perso_nom" placeholder="Nom"/>
                </div>
                <div class="grid-character-race">
                    Race: <input type="text" class="sheet-input-text" spellcheck="false" name="attr_perso_race" placeholder="Race"/> 
                </div>
                <div class="grid-character-classe">
                    Classe: <input type="text" class="sheet-input-text" spellcheck="false" name="attr_perso_classe" placeholder="Classe"/>
                </div>
                <div class="grid-character-element">
                    Élement: <input type="text" class="sheet-input-text" spellcheck="false" name="attr_perso_element" placeholder="Élement"/>
                </div>
                <div class="grid-character-themes">
                    Thèmes:<br>
                    <textarea class="themes-langues" spellcheck="false" name="attr_perso_themes" placeholder="Thèmes"></textarea>
                </div> 
                <div class="grid-character-langues">
                    Langues connues:<br>
                    <textarea class="themes-langues" spellcheck="false" name="attr_perso_langues" placeholder="Langues connues"></textarea>
                </div>
            </div>
        </div>

        <!-- Stats du personnage-->
        <div class="sheet-block">
            <div class="sheet-head">
                Statistiques
            </div>
            <div class="grid-global-stats">
                <!-- Stats principales et secondaires : exemple Physique - Puissance - Agilité -->
                <div class="grid-stats">
                    <div class="grid-stats-physique">
                        Physique
                    </div>
                    <div class="grid-stats-social">
                        Social 
                    </div>
                    <div class="grid-stats-mental">
                        Mental
                    </div>

                    <div class="grid-stats-physique-value">
                        <input type="number" class="sheet-number-main" name="attr_physique">

                        <!-- On lance un dés qui s'affiche en rouge en cas d'échec critique (entre 96 et 100) et en vert en cas de réussite critique (5 ou moins)
                             et on affiche la stats concernée + les modificateurs bonus/malus
                            plus d'info : https://wiki.roll20.net/Dice_Reference#Critical_Success_and_Fumble_Points -->

                        <button type='roll' value='/me effectue un jet de Physique ! [[1d100cs<5cf>96]] vs: [[@{physique}+@{mod}+@{modfatigue}]]' name='roll_Physique'></button> 

                            <!-- le format de la value est une macro roll20 : https://wiki.roll20.net/Macros -->
                    </div>
                    <div class="grid-stats-social-value">
                        <input type="number" class="sheet-number-main" name="attr_social">
                        <button type='roll' value='/me effectue un jet de Social ! [[1d100cs<5cf>96]] vs: [[@{social}+@{mod}]]' name='roll_Social'></button>
                    </div> 
                    <div class="grid-stats-mental-value">
                        <input type="number" class="sheet-number-main" name="attr_mental">
                        <button type='roll' value='/me effectue un jet de Mental ! [[1d100cs<5cf>96]] vs: [[@{mental}+@{mod}+@{modfatigue}]]' name='roll_Mental'></button>
                    </div>

                    <div class="grid-stats-puissance">
                        Puissance
                    </div>
                    <div class="grid-stats-finesse">
                        Finesse 
                    </div>
                    <div class="grid-stats-aura">
                        Aura
                    </div>
                    <div class="grid-stats-relations">
                        Relations
                    </div>
                    <div class="grid-stats-instinct">
                        Instinct 
                    </div>
                    <div class="grid-stats-savoir">
                        Savoir
                    </div>

                    <!-- On définit en caché les jets possibles pour les sous-catégories des stats principales -->
                    <input type="number" disabled="true" class="sheet-query" value="?{type de dé|d6, 1d6cs1cf6|d8, 1d8cs1cf8|d10, 1d10cs1cf10|d12, 1d12cs1cf12|d20, 1d4cs1cf4}" name="attr_query">

                    <div class="grid-stats-puissance-value">
                        <input type="number" class="sheet-number" name="attr_puissance">

                        <!-- On lance le dés choisi par le joeur dans la query ci-dessus et on compare à la stat + le modificateur de bonus/malus -->

                        <button type='roll' value="/me effectue un jet de Puissance ! [[@{query}]] vs: [[@{puissance}+@{mod}]]" name='roll_Puissance'></button>          
                    </div>
                    <div class="grid-stats-finesse-value">
                        <input type="number" class="sheet-number" name="attr_finesse">
                        <button type='roll' value="/me effectue un jet de Finesse ! [[@{query}]] vs: [[@{finesse}+@{mod}]]" name='roll_Finesse'></button> 
                    </div>
                    <div class="grid-stats-aura-value">
                        <input type="number" class="sheet-number" name="attr_aura">
                        <button type='roll' value="/me effectue un jet d'Aura ! [[@{query}]] vs: [[@{aura}+@{mod}]]" name='roll_Aura'></button>
                    </div>
                    <div class="grid-stats-relations-value">
                        <input type="number" class="sheet-number" name="attr_relation">
                        <button type='roll' value="/me effectue un jet de Relations ! [[@{query}]] vs: [[@{relation}+@{mod}]]" name='roll_Relations'></button>
                    </div>
                    <div class="grid-stats-instinct-value">
                        <input type="number" class="sheet-number" name="attr_instinct">
                        <button type='roll' value="/me effectue un jet d'Instinct ! [[@{query}]] vs: [[@{instinct}+@{mod}]]" name='roll_Instinct'></button> 
                    </div>
                    <div class="grid-stats-savoir-value">
                        <input type="number" class="sheet-number" name="attr_savoir">
                        <button type='roll' value="/me effectue un jet de Savoir ! [[@{query}]] vs: [[@{savoir}+@{mod}]]" name='roll_Savoir'></button>
                    </div>

                    <!-- Etat de fatigue -->
                    <div class="grid-carton">
                            <div> Etat de fatigue
                                <!-- Fatiguer = -30% aux stats Mental et Physique, Ereinté = stats ingame (Pv et Psy) divisées par 2 -->
                                <input type='checkbox' class="sheet-carton-jaune" name='attr_fatigue_jaune' aria-label="Fatigué"/>
                                <input type='checkbox' class="sheet-carton-rouge" name='attr_fatigue_rouge' aria-label="Ereinté"/>

                                <!-- On définit la valeur de la fatigue, 0 par défaut -->
                                <input name="attr_modfatigue" type="hidden" value="0">

                                <!-- Input afin de stocker les valeurs MAX -->
                                <input name="attr_sante_max_stock" type="hidden">
                                <input name="attr_psy_max_stock" type="hidden">
                            </div>
                    </div>

                    <!-- Avantage ou désavantage actif ? Sert de rappel pour le joueur/MJ -->
                    <div class="grid-avantage">
                        Avantage
                        <img src="https://raw.githubusercontent.com/Mihawk59/AventuresV2/main/avantage.png"  width="15px" height="15px">
                        <input type='checkbox' name='attr_avantage'/>
                        | Désavantage
                        <img src="https://raw.githubusercontent.com/Mihawk59/AventuresV2/main/desavantage.png"  width="12px" height="12px">
                        <input type='checkbox' name='attr_desavantage' />
                    </div>
                </div>

                <!-- Stats ingame : Lvl, PV, Psy, ect... -->
                <div class="grid-stats-ingame">
                    <div class="grid-stats-lvl">
                        Niveau
                    </div>
                    <div class="grid-stats-lvl-value">
                        <input type="number" class="sheet-number-main" name="attr_niveau">
                    </div>
                    <div class="grid-stats-pv">
                        PV
                    </div>
                    <div class="grid-stats-pv-value">
                        <input type="number" class="sheet-number-main" name="attr_sante">
                        /
                        <input type="number" class="sheet-number-bar-max" name="attr_sante_max">
                    </div>
                    <div class="grid-stats-psy">
                        Psy
                    </div>
                    <div class="grid-stats-psy-value">
                        <input type="number" class="sheet-number-main" name="attr_psy">
                        /
                        <input type="number" class="sheet-number-bar-max" name="attr_psy_max">
                    </div>
                    <div class="grid-stats-fatigue">
                        Fatigue
                    </div>
                    <div class="grid-stats-fatigue-value">
                        <input type="number" class="sheet-number-main" name="attr_fatigue">
                        /
                        <input type="number" class="sheet-number-bar-max" name="attr_fatigue_max">
                    </div>
                    <div class="grid-stats-vitesse">
                        Vitesse
                    </div>
                    <div class="grid-stats-vitesse-value">
                        <input type="number" class="sheet-number" name="attr_vitesse">

                        <!-- Stock la vitesse max autorisée par le personnage, hors bonus -->
                        <input name="attr_vitesse_stock" type="hidden">
                    </div>
                    <div class="grid-stats-posture">
                        Posture de base
                    </div>
                    <div class="grid-stats-posture-value">
                        <select name="attr_posture" class="sheet-select">
                            <option value="posture" selected>Posture </option> 
                            <option value="offensif">Offensif </option>              
                            <option value="defensif">Défensif </option> 
                            <option value="focus">Focus </option>
                        </select>                    
                    </div>
                </div>
            </div>
        </div>

        <div class="tab" name="attr_tab">
            <button class="tablinks" type="action" name="act_competences">Competences</button>
            <button class="tablinks" type="action" name="act_equipement">Equipement</button>
        </div>

        <!-- Mise en place des tabs, par défaut sur competences -->
        <input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab"  value="competences"/>
        <div class="sheet-competences">
            <!-- Compétences et dons -->
            <div class="sheet-block">
                <div class="sheet-head">
                    Compétences et dons
                </div> 
                <div class="grid-competences-dons">  

                    <!-- Répétitions de compétences, création de ligne à la volé -->
                    <div class='grid-competences'>
                        Compétences
                        <fieldset class="repeating_competences">        
                            <div>
                                <input type="text" class="sheet-text-competence" spellcheck="false" name="attr_competence" placeholder="Compétence"/>
                                <select name="attr_competence_attr" class="sheet-select">
                                    <option value="0">Attribut</option>              
                                    <option value="@{physique}">Physique</option> 
                                    <option value="@{social}">Social</option>
                                    <option value="@{mental}">Mental</option>
                                </select>
                                +
                                <input type="number" class="sheet-number-long" name="attr_competence_mod">
                                <!-- On lance un test de compétence en prenant en compte la stat principale + le bonus de compétence + le modificateur de bonus/malus -->
                                <button type='roll' value="/me teste sa compétence  @{competence} ! [[1d100cs<5cf>96]] vs: [[@{competence_attr}+@{competence_mod}+@{mod}]]" name='roll_Comp'></button>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Répétitions de dons, création de ligne à la volé -->
                    <div class='grid-dons'>
                        Dons
                        <fieldset class="repeating_dons">
                            <div>
                                <input type="text" class="sheet-text-don" spellcheck="false" name="attr_don" placeholder="Don"/>
                                <input type="number" placeholder="Psy" class="sheet-number-don-cost" name="attr_don_psy">
                                <input type="number" name="attr_don_dmgdice"  class="sheet-number" placeholder="1">
                                <select name="attr_don_dX" class="sheet-comp-dX-select" placeholder="type">
                                    <option value="x">d?</option>
                                    <option value="d4">d4</option>              
                                    <option value="d6">d6</option> 
                                    <option value="d8">d8</option>
                                    <option value="d10">d10</option>
                                    <option value="d12">d12</option>
                                    <option value="d20">d20</option>
                                </select>
                                <!-- On lance le don et les dégâts de celui-ci. Attention, le coût en psy n'est pas retiré automatiquement, les macros roll20 ne le permettent pas -->
                                <button type='roll' value="/me lance le sort @{don} et inflige [[(@{don_dmgdice}@{don_dX})+@{mod}]] !" name='roll_dmg'></button>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <div class="grid-competences-passiv">
                    Passives <br>
                    <textarea class="textarea.passiv" spellcheck="false" name="attr_competencespassives" placeholder="Passives" ></textarea>
                </div> 
            </div>
        </div>

        <div class="sheet-equipement">
            <!-- Equipement -->
            <div class="sheet-block">
                <div class="sheet-head">
                    Équipement
                </div> 
                <div class="grid-equipement">  

                    <!-- Répétitions d'armes, création de ligne à la volé -->
                    <div class="grid-armes">
                        Armes
                        <fieldset class="repeating_armes">
                            <div>
                                <input type="text" class="sheet-arme" spellcheck="false" name="attr_arme" placeholder="Arme" /> 
                                <select name="attr_arme_type" class="sheet-select">
                                    <option value="none">Type</option>              
                                    <option value="perforant">Perforant</option> 
                                    <option value="tranchant">Tranchant</option>
                                    <option value="contondant">Contondant</option>
                                </select>
                                <input type="number" name="attr_arme_dmgdice"  class="sheet-number" placeholder="1">
                                <select name="attr_arme_dX" class="sheet-comp-dX-select" placeholder="type">
                                    <option value="x">d?</option>
                                    <option value="d4">d4</option>              
                                    <option value="d6">d6</option> 
                                    <option value="d8">d8</option>
                                    <option value="d10">d10</option>
                                    <option value="d12">d12</option>
                                    <option value="d20">d20</option>
                                </select> 
                                + 
                                <input type="number" class="sheet-number" name="attr_arme_dmgmod">

                                <!-- On affiche le nombre de dégât en prenant en compte les dégâts fixes et le type de dégât en fonction de l'arme -->
                                <button type='roll' value='/me inflige [[(@{arme_dmgdice}@{arme_dX})+@{arme_dmgmod}]] de dégâts @{arme_type} avec @{arme} !' name='roll_dmg'></button>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Répétitions d'armures, création de ligne à la volé -->
                    <div class="grid-armure">
                        Armure
                        <fieldset class="repeating_armure">
                            <div>
                                <input type="text" class="sheet-armure" spellcheck="false" name="attr_armure" placeholder="Armure" />
                                <input type="number" class="sheet-number-long" name="attr_armure_physique" placeholder="Phy" />
                                <input type="number" class="sheet-number-long" name="attr_armure_magique" placeholder="Mag" />
                            </div>
                        </fieldset>
                    </div>

                    <!-- Répétitions d'équipements, création de ligne à la volé -->
                    <div class="grid-sac">
                        Equipement total (en Kg)
                        <fieldset class="repeating_equipements">        
                            <div>
                                <input type="text" class="sheet-objet-nom" spellcheck="false" name="attr_equipement" placeholder="Objet" />
                                <input type="number" class="sheet-number-long" spellcheck="false" name="attr_equipement_nombre" placeholder="Nb" /> 
                                <input type="number" class="sheet-number-long" spellcheck="false" name="attr_equipement_poids" placeholder="Kg" /> 
                            </div>
                        </fieldset>

                        <!-- On affiche de poids total, basé sur le script repeatingSum -->
                        Poids total
                        <div>
                        <input type="number" class="sheet-objet-long" spellcheck="false" name="attr_poids_total" value="0" readonly/>
                        /
                        <input type="number" class="sheet-objet-long" spellcheck="false" name="attr_poids_maximum"/>
                        </div>
                    </div>

                    <!-- Champ libre -->
                    <div class="grid-autre">
                        Autres 
                        <div>
                            <textarea class="textarea.autres" spellcheck="false" name="attr_autre" placeholder="Autres" ></textarea>     
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active/Desactive l'ajout d'une boite de dialogue pour ajouter des bonus/malus aux jets -->
        <div class="sheet-options"> 
            Bonus/malus dans les jets: <input type="checkbox" value="?{Bonus/malus|0}[mod]" name="attr_mod" checked="true">
        </div>
    </div>
</div>

<div class="ver"> Ver. 1.0 </div><!-- Version format: [Nb de prod].[Modifs post-prod] -->

<!-- Scripts -->
<script type="text/worker">
    //Calcul de la vitesse du personnage basé sur Finesse*2
    on('change:finesse', function() {
        getAttrs(['finesse', "vitesse"," vitesse_stock"], function(values) {
            let finessevalue = parseInt(values.finesse)||0;
    
            setAttrs({     
                vitesse: Math.ceil(finessevalue * 2),
                vitesse_stock: Math.ceil(finessevalue * 2)
            });
        });
    });

    //Calcul du poids max basé sur puissance*10
    on('change:puissance', function() {
        getAttrs(['puissance', "poids_maximum"], function(values) {
            let puissanceact = parseInt(values.puissance)||0;
    
            setAttrs({     
                poids_maximum: Math.ceil(puissanceact * 10)
            });
        });
    });

    //Calcul du poids total
    const repeatingSum = (destinations, section, fields) => {
        if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
        if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
        getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;

            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);

            const output = {};
            destinations.forEach((destination, index) => {
                output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
            });
                console.log(output);
                setAttrs(output);
            }); 
        }); 
    };

    //Lignes d'équipement total
    on('change:repeating_equipements remove:repeating_equipements', function() {
        repeatingSum("poids_total","equipements",["equipement_poids","equipement_nombre"]);
    }); 

    //IDs des nouvelles lignes créées à la volée
    on(`sheet:opened`, function() {
        var newrowattrs = {};
        newrowattrs['code_version'] = 1;
        var newrowid = generateRowID();
        
        newrowid = generateRowID();
        newrowattrs["repeating_competences_" + newrowid + "_competence"] = values.competence;
        newrowattrs["repeating_competences_" + newrowid + "_competence_attr"] = values.competence_attr;
        newrowattrs["repeating_competences_" + newrowid + "_competence_mod"] = values.competence_mod;

        newrowid = generateRowID();
        newrowattrs["repeating_dons_" + newrowid + "_don"] = "values.don";
        newrowattrs["repeating_dons_" + newrowid + "_don_psy"] = "values.don_psy";
        newrowattrs["repeating_dons_" + newrowid + "_don_dmgdice"] = "values.don_dmgdice";
        newrowattrs["repeating_dons_" + newrowid + "_don_dX"] = "values.don_dX";

        newrowid = generateRowID();
        newrowattrs["repeating_armes_" + newrowid + "_arme"] = "values.arme";
        newrowattrs["repeating_armes_" + newrowid + "_arme_type"] = "values.arme_type";
        newrowattrs["repeating_armes_" + newrowid + "_arme_dmgdice"] = "values.arme_dmgdice";
        newrowattrs["repeating_armes_" + newrowid + "_arme_dX"] = "values.arme_dX";
        newrowattrs["repeating_armes_" + newrowid + "_arme_dmgmod"] = "values.arme_dmgmod";
                
        newrowid = generateRowID();
        newrowattrs["repeating_armure_" + newrowid + "_armure"] = "values.armure";
        newrowattrs["repeating_armure_" + newrowid + "_armure_physique"] = "values.armure_physique";
        newrowattrs["repeating_armure_" + newrowid + "_armure_magique"] = "values.armure_magique";

        newrowid = generateRowID();
        newrowattrs["repeating_equipements_" + newrowid + "_equipement"] = "values._equipement";
        newrowattrs["repeating_equipements_" + newrowid + "_equipement_nombre"] = "values.equipement_nombre";
        newrowattrs["repeating_equipements_" + newrowid + "_equipement_poids"] = "values.equipement_poids";

        setAttrs(newrowattrs);
    });

    //Applique -30% aux jets de stats globales Mental et Physique
    on('change:fatigue_jaune', function() {
        getAttrs(['fatigue_jaune', "modfatigue"], function(values) {
            if (values.fatigue_jaune == 'on') {
                setAttrs({
                    modfatigue: -30                
                });
            } else {
                setAttrs({     
                    modfatigue: 0                   
                });
            }
        });
    });

    //Divise la sante et la psy par 2 si éreinté est coché, remet à la valeur max lorsque décoché, valeur max à renseigner dans les attributs directement
    on('change:fatigue_rouge', function() {
        getAttrs(['fatigue_rouge',"sante_max","sante_max_stock","psy_max","psy_max_stock"], function(values) {
            let sante = parseInt(values.sante_max)||0;
            let santestock = parseInt(values.sante_max_stock)||0;
            let psy = parseInt(values.psy_max)||0;
            let psystock = parseInt(values.psy_max_stock)||0;

            if (values.fatigue_rouge == 'on') {
                setAttrs({
                    sante_max: Math.ceil(sante / 2),
                    psy_max: Math.ceil(psy / 2)                    
                });
            } else {
                setAttrs({     
                    sante_max: santestock,
                    psy_max: psystock        
                });
            }
        });
    });

    //Diminue la vitesse de 30% en cas d'exédent de poids de 30% (+0-25%), puis 60% en cas de surcharge (+25-50%) et enfin met à 0 si le poids est trop lourd (+50%)
    on('change:poids_total change:poids_maximum change:repeating_equipements remove:repeating_equipements', function() {
        getAttrs(['poids_total',"poids_maximum","vitesse","vitesse_stock"], function(values) {
            let poidstotal = parseInt(values.poids_total)||0;
            let poidsmax = parseInt(values.poids_maximum)||0;
            let vitessemax = parseInt(values.vitesse_stock)||0;

            let poids25 = Math.floor(values.poids_maximum * 1.25);
            let poids50 = Math.floor(values.poids_maximum * 1.5);

            if (values.poids_total > values.poids_maximum) {
                if (values.poids_total <= poids25) {
                    setAttrs({     
                        vitesse: Math.ceil(vitessemax * 0.70)
                    });
                } else {
                    if (values.poids_total <= poids50) {
                        setAttrs({
                            vitesse: Math.ceil(vitessemax * 0.40)
                        });
                    } else {
                        setAttrs({     
                            vitesse: 0
                        });
                    }
                }
            } else {
                setAttrs({     
                    vitesse: vitessemax
                });
            }
        });
    });

    //Gestion des tabs
    const buttontablist = ["competences","equipement"];
    buttontablist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });
</script>