<div class="main_container" >
    <input class="npc_toggle" name="attr_npc" type="hidden" value="0"/>
    <button type="action" name="act_showpc" class="npc"><span >PC</span></button>
    <button type="action" name="act_shownpc" class="pc"><span >NPC</span></button>
    
    
    <div class="container npc">
        <span >NPC - secton</span>
    </div>
<!--PC sekce-->    
    <div class="container pc">
<!--PC Hlavicka sekce--> 
        <div class="container pc_hlavicka flex-center">
            <div class="pc_name section">
                <div class="section-small flex-center">
                    <label>Jméno: </label>
                    <input name="attr_character_name" type="text" class="">
                </div>
                <div class="section-small flex-center">
                    <label>Povolání: </label>
                  <!--<input name="attr_race" type="text">-->
                    <select name="attr_povolani"> 
                        <option value="Alchymista">Alchymista</option>
                        <option value="Alchymista-Theurg">Alchymista - Theurg</option>
                        <option value="Alchymista-Pyrofor">Alchymista - Pyrofor</option>
                        <option value="Hraničář">Hraničář</option>
                        <option value="Hraničář-Druid">Hraničář - Druid</option>
                        <option value="Hraničář-Chodec">Hraničář - Chodec</option>
                        <option value="Kouzelník">Kouzelník</option>
                        <option value="Kouzelník-Mág">Kouzelník - Mág</option>
                        <option value="Kouzelník-Čaroděj">Kouzelník - Čaroděj</option>
                        <option value="Válečník">Válečník</option>
                        <option value="Válečník-Bojovník">Válečník - Bojovník</option>
                        <option value="Válečník-Šermíř">Válečník - Šermíř</option>
                        <option value="Zloděj">Zloděj</option>
                        <option value="Zloděj-Lupič">Zloděj - Lupič</option>
                        <option value="Zloděj-Sicco">Zloděj - Sicco</option>
                    </select>
                </div>
                <div class="section-small flex-center">
                    <label>Rasa: </label>
                  <!--<input name="attr_race" type="text">-->
                    <select name="attr_rasa"> 
                        <option value="Člověk">Člověk</option>
                        <option value="Barbar">Barbar</option>
                        <option value="Hobit">Hobit</option>
                        <option value="Elf">Elf</option>
                        <option value="Trpaslík">Trpaslík</option>
                        <option value="Kudůk">Kudůk</option>
                        <option value="Kroll">Kroll</option>
                    </select>
                    <select name="attr_velikost" class="velikost"> 
                        <option value="0">A0</option>
                        <option value="1">A</option>
                        <option value="2">B</option>
                        <option value="3">C</option>
                        <option value="4">D</option>
                        <option value="5">E</option>
                    </select>
                </div>
            </div>

            <div class="pc_stav section">
                <div class="section-small flex-center">
                    <input name="attr_level" type="number" class="level" value="1">
                    <span name="attr_bojeschopnost">Vyřazen (-1)</span>
                    <span name="attr_pretizeni">Přetížen (-2)</span>
                </div>
                <div class="section-small flex-center points">
                  <label>Max Životů: </label>
                  <input name="attr_hit_points_max" type="number" value="0">
                  <label>Max Magů: </label>
                  <input name="attr_mag_points_max" type="number" value="0">
                </div>
                <div class="section-small flex-center">
                  <label>Stav: </label>
                  <input name="attr_hit_points" type="number" value="0">
                  <label>Stav: </label>
                  <input name="attr_mag_points" type="number" value="0">
                </div>
            </div>
            
            <div class="pc_akce section">
                <div class="section-small flex-center ucoc">
                    <div class="setradio flex-down">
                        <div><input type="checkbox" name="attr_nehybny_volba" value="1" />Nehybný</div>
                        <div><input type="checkbox" name="attr_vyrazeny_volba" value="1" />Vyřazený</div>
                        <div></div>
                    </div>
                    <button name="roll_utok" type="roll" class="attack" value="&{template:Utok} {{name=Útok}} {{utoc=@{ucutoc}}} {{Result=[[1d6! + (@{uc}) + (@{ucopr})]]}}"><span class="small">Útok</span></button>
                    <span name="attr_uc" class="ucoc">0</span>
                    <span name="attr_ucopr" class="ucoc">0</span>
                    <span name="attr_ucutoc" class="ucoc">0</span>
                </div>
                <div class="section-small flex-center ucoc">
                    <div class="setradio flex-down">
                        <div><input type="radio" name="attr_oz_volba" value="1" checked="true"> OZ </div>
                        <div><input type="radio" name="attr_oz_volba" value="-3"> -3</div>
                        <div><input type="radio" name="attr_oz_volba" value="0"> 0</div>
                    </div>
                    <button name="roll_obrana" type="roll" class="attack" value="&{template:Obrana} {{name=Obrana}} {{Result=[[1d6! + (@{oc}) + (@{ocopr})]]}}"><span class="small">Obrana</span></button>
                    <span name="attr_oc" class="ucoc">0</span>
                    <span name="attr_ocopr" class="ucoc">0</span>
                </div>
                <div class="section-small flex-center">
                  <button name="roll_init" type="roll" class="iniciativa" value="&{template:default} {{name=Initiative}} {{Result=[[d6]]}} &{tracker}"><span>Iniciativa</span></button>
                  <label>základ / oprava / útočnost</label>
                </div>
            </div>   
        </div>
        
        <input class="pc_toggle_page" name="attr_pc_page" type="hidden" value="0"/>
        <div class="pc_selector">
            <div class="section-small flex-center">
                <button type="action" class="pc_main" name="act_showpc_main"><span >Hlavní</span></button>
                <button type="action" class="pc_schopnosti" name="act_showpc_schopnosti"><span >Schopnosti</span></button>
                <button type="action" class="pc_vybava" name="act_showpc_vybava"><span >Výbava</span></button>
                <button type="action" class="pc_extra" name="act_showpc_extra"><span >Extra</span></button>
            </div>
        </div>  
<!--PC Main sekce-->        
        <div class="container pc_main">
            <div class="pc_stats section">
                <div class="stat-block flex-center vlastnost">
                  <label>Síla</label>
                  <input name="attr_sil" type="number" value="1">
                  <span name="attr_sil_mod">5</span>
                  <button name="roll_sila" type="roll" value="&{template:default} {{name=Sila}} {{Result=[[d10+(@{sil_mod})]]}}"></button>
                </div>
            
                <div class="stat-block flex-center vlastnost">
                  <label>Odolnost</label>
                  <input name="attr_odl" type="number" value="1">
                  <span name="attr_odl_mod">-5</span>
                  <button name="roll_odolnost" type="roll" value="&{template:default} {{name=Odolnost}} {{Result=[[d10+(@{odl_mod})]]}}"></button>
                </div>
            
                <div class="stat-block flex-center vlastnost">
                  <label>Obratnost</label>
                  <input name="attr_obr" type="number" value="1">
                  <span name="attr_obr_mod">5</span>
                  <button name="roll_obratnost" type="roll" value="&{template:default} {{name=Obratnost}} {{Result=[[d10+(@{obr_mod})]]}}"></button>
                </div>
            
                <div class="stat-block flex-center vlastnost">
                  <label>Inteligence</label>
                  <input name="attr_int" type="number" value="1">
                  <span name="attr_int_mod">-5</span>
                  <button name="roll_inteligence" type="roll" value="&{template:default} {{name=Inteligence}} {{Result=[[d10+(@{int_mod})]]}}"></button>
                </div>
            
                <div class="stat-block flex-center vlastnost">
                  <label>Charisma</label>
                  <input name="attr_chr" type="number" value="1">
                  <span name="attr_chr_mod">5</span>
                  <button name="roll_charisma" type="roll" value="&{template:default} {{name=Charisma}} {{Result=[[d10+(@{chr_mod})]]}}"></button>
                </div>
            
                <div class="stat-block flex-center vlastnost">
                  <label>Pohyblivost</label>
                  <input name="attr_poh" type="number" value="1">
                  <span name="attr_poh_mod">-5</span>
                  <button name="roll_pohyblivost" type="roll" value="&{template:default} {{name=Pohyblivost}} {{Result=[[d10+(@{poh_mod})]]}}"></button>
                </div>
                
                <div class="section-small flex-center pohyb">
                  <input type="radio" name="attr_nalozeni" value="0">
                  <label>žádné</label>
                  <span name="attr_poh_0_vaha" class="vaha">X</span>
                  <span name="attr_poh_0">X</span>
                  <span name="attr_poh_0_mod">X</span>
                </div>
                <div class="section-small flex-center pohyb">
                  <input type="radio" name="attr_nalozeni" value="1">
                  <label>mírmé</label>
                  <span name="attr_poh_1_vaha" class="vaha">X</span>
                  <span name="attr_poh_1">X</span>
                  <span name="attr_poh_1_mod">X</span>
                </div>
                <div class="section-small flex-center pohyb">
                  <input type="radio" name="attr_nalozeni" value="2">
                  <label>střední</label>
                  <span name="attr_poh_2_vaha" class="vaha">X</span>
                  <span name="attr_poh_2">X</span>
                  <span name="attr_poh_2_mod">X</span>
                </div>
                <div class="section-small flex-center pohyb">
                  <input type="radio" name="attr_nalozeni" value="3">
                  <label>velké</label>
                  <span name="attr_poh_3_vaha" class="vaha">X</span>
                  <span name="attr_poh_3">X</span>
                  <span name="attr_poh_3_mod">X</span>
                </div>
            
                 <div class="section-small flex-center mezi">
                  <label>Náhodné / Hledání</label>
                  <button name="roll_nahoda" type="roll" value="&{template:Hledani} {{name=Náhodný postřeh}} {{Obj=[[ 1d100 - (@{postreh_obj}) ]]}} {{Mech=[[ 1d100 - (@{postreh_mech}) ]]}}"></button>
                  <button name="roll_hledani" type="roll" value="&{template:Hledani} {{name=Hledání}}  {{Obj=[[ 1d100 - (@{postreh_obj_hledani}) ]]}} {{Mech=[[ 1d100 - (@{postreh_mech_hledani}) ]]}}"></button>
                </div>
               <div class="stat-block flex-center hledani">
                  <label>Objekty</label>
                  <input name="attr_postreh_obj" type="number" value="3">
                  <input name="attr_postreh_obj_hledani" type="number" value="10">
                </div>
                <div class="stat-block flex-center hledani">
                  <label>Mechanismy</label>
                  <input name="attr_postreh_mech" type="number" value="3">
                  <input name="attr_postreh_mech_hledani" type="number" value="10">
                </div>
            </div>

        <!--        &{template:default} {{name=Trap}} {{Pikes=[[1d4]]}} {{Damages=[Throw](~PikesDamages$[[0]])}} -->
        <!-- [[1d4]] [[ $[[0]]d4 + 2*$[[0]] ]] -->
            <div class="pc_tvt section">
                <div class="section-small flex-center popisky">
                    <button type="action" class="pc_bojadd" name="act_pc_addtvt"><span >+</span></button>
                    <label class="jmeno">Zbraň pro boj TvT</label>
                    <label>2H?</label>
                    <label>ÚČ</label>
                    <label>útoč.</label>
                    <label>OZ</label>
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="tvt1">
                  <input name="attr_tvt1" type="text" class="jmeno" value="rapír">
                  <input type="checkbox" name="attr_tvt1_2h" class="2h" value="1" />
                  <input name="attr_tvt1_uc" type="number" value="3">
                  <input name="attr_tvt1_uto" type="number" value="1">
                  <input name="attr_tvt1_oz" type="number" value="2">
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="tvt2">
                  <input name="attr_tvt2" type="text" class="jmeno" value="dýka">
                  <input type="checkbox" name="attr_tvt2_2h" class="2h" value="1" />
                  <input name="attr_tvt2_uc" type="number" value="1">
                  <input name="attr_tvt2_uto" type="number" value="0">
                  <input name="attr_tvt2_oz" type="number" value="1">
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="tvt3">
                  <input name="attr_tvt3" type="text" class="jmeno" value="">
                  <input type="checkbox" name="attr_tvt3_2h" class="2h" value="1" />
                  <input name="attr_tvt3_uc" type="number" value="">
                  <input name="attr_tvt3_uto" type="number" value="">
                  <input name="attr_tvt3_oz" type="number" value="">
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="tvt4">
                  <input name="attr_tvt4" type="text" class="jmeno" value="">
                  <input type="checkbox" name="attr_tvt4_2h" class="2h" value="1" />
                  <input name="attr_tvt4_uc" type="number" value="">
                  <input name="attr_tvt4_uto" type="number" value="">
                  <input name="attr_tvt4_oz" type="number" value="">
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="tvt5">
                  <input name="attr_tvt5" type="text" class="jmeno" value="">
                  <input type="checkbox" name="attr_tvt5_2h" class="2h" value="1" />
                  <input name="attr_tvt5_uc" type="number" value="">
                  <input name="attr_tvt5_uto" type="number" value="">
                  <input name="attr_tvt5_oz" type="number" value="">
                </div>
            </div>
            
            
            <div class="pc_strel section">
                <div class="section-small flex-center popisky">
                    <button type="action" class="pc_bojadd" name="act_pc_addstrel"><span >+</span></button>
                    <label class="jmeno">Zbraň pro střelbu</label>
                    <label>2H?</label>
                    <label>ÚČ</label>
                    <label>útoč.</label>
                    <label>min./střední/max.</label>
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="strel1">
                  <input name="attr_strel1" type="text" class="jmeno" value="Dlouhý luk">
                  <input type="checkbox" name="attr_strel1_2h" class="2h" value="1" />
                  <input name="attr_strel1_uc" type="number" value="5">
                  <input name="attr_strel1_uto" type="number" value="1">
                  <input name="attr_strel1_maly" type="number" value="15">
                  <input name="attr_strel1_stredni" type="number" value="30">
                  <input name="attr_strel1_velky" type="number" value="50">
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="strel2">
                   <input name="attr_strel2" type="text" class="jmeno" value="">
                  <input type="checkbox" name="attr_strel2_2h" class="2h" value="1" />
                  <input name="attr_strel2_uc" type="number" value="">
                  <input name="attr_strel2_uto" type="number" value="">
                  <input name="attr_strel2_maly" type="number" value="">
                  <input name="attr_strel2_stredni" type="number" value="">
                  <input name="attr_strel2_velky" type="number" value="">
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="strel3">
                   <input name="attr_strel3" type="text" class="jmeno" value="">
                  <input type="checkbox" name="attr_strel3_2h" class="2h" value="1" />
                  <input name="attr_strel3_uc" type="number" value="">
                  <input name="attr_strel3_uto" type="number" value="">
                  <input name="attr_strel3_maly" type="number" value="">
                  <input name="attr_strel3_stredni" type="number" value="">
                  <input name="attr_strel3_velky" type="number" value="">
                </div>
                <div class="section-small flex-center radek">
                    <input type="radio" name="attr_zbran" value="strel4">
                   <input name="attr_strel4" type="text" class="jmeno" value="">
                   <input type="checkbox" name="attr_strel4_2h" class="2h" value="1" />
                 <input name="attr_strel4_uc" type="number" value="">
                  <input name="attr_strel4_uto" type="number" value="">
                  <input name="attr_strel4_maly" type="number" value="">
                  <input name="attr_strel4_stredni" type="number" value="">
                  <input name="attr_strel4_velky" type="number" value="">
                </div>
            </div>
            
            <div class="pc_zbroj section">
                <div class="section-small flex-center popisky">
                    <button type="action" class="pc_bojadd" name="act_pc_addzbroj"><span >+</span></button>
                    <label class="jmeno">Zbroj</label>
                    <label>štít?</label>
                    <label>OČ</label>
                </div>
                <div class="section-small flex-center radek">
                  <input type="checkbox" name="attr_zboj1_use" checked="false" value="1"/>
                  <input name="attr_zboj1" type="text" class="jmeno" value="Vycpávaná zbroj">
                  <input type="checkbox" name="attr_zboj1_stit" class="2h" value="1" />
                  <input name="attr_zboj1_oc" type="number" value="2">
                </div>
                <div class="section-small flex-center radek">
                  <input type="checkbox" name="attr_zboj2_use" value="1" />
                  <input name="attr_zboj2" type="text" class="jmeno" value="Štít">
                  <input type="checkbox" name="attr_zboj2_stit" class="2h" value="1" />
                  <input name="attr_zboj2_oc" type="number" value="1">
                </div>
                <div class="section-small flex-center radek">
                  <input type="checkbox" name="attr_zboj3_use" value="1" />
                  <input name="attr_zboj3" type="text" class="jmeno" value="">
                  <input type="checkbox" name="attr_zboj3_stit" class="2h" value="1" />
                  <input name="attr_zboj3_oc" type="number" value="">
                </div>
            </div>
        </div>
        
<!--PC Schopnosti sekce-->        
        <div class="container pc_schopnosti">
            <span >PC - schopnosti</span>
        </div>
<!--PC Vybava sekce-->        
        <div class="container pc_vybava">
            <span >PC - vybava</span>
        </div>
<!--PC Extra sekce-->        
        <div class="container pc_extra">
            <span >PC - extra</span>
        </div>
    </div>
    
</div>





<input name="attr_sil_mod" type="hidden" value="0">
<input name="attr_int_mod" type="hidden" value="0">
<input name="attr_chr_mod" type="hidden" value="0">
<input name="attr_odl_mod" type="hidden" value="0">
<input name="attr_obr_mod" type="hidden" value="0">
<input name="attr_poh_mod" type="hidden" value="0">
<input name="attr_poh_0_vaha" type="hidden" value="(mn)">
<input name="attr_poh_0"      type="hidden" value="0">
<input name="attr_poh_0_mod"  type="hidden" value="0">
<input name="attr_poh_1_vaha" type="hidden" value="(mn)">
<input name="attr_poh_1"      type="hidden" value="0">
<input name="attr_poh_1_mod"  type="hidden" value="0">
<input name="attr_poh_2_vaha" type="hidden" value="(mn)">
<input name="attr_poh_2"      type="hidden" value="0">
<input name="attr_poh_2_mod"  type="hidden" value="0">
<input name="attr_poh_3_vaha" type="hidden" value="(mn)">
<input name="attr_poh_3"      type="hidden" value="0">
<input name="attr_poh_3_mod"  type="hidden" value="0">
<input name="attr_nosnost"       type="hidden" value="0">
<input name="attr_nalozeni"      type="hidden" value="0">
<input name="attr_pretizeni"     type="hidden" value="">
<input name="attr_pretizeni_mod" type="hidden" value="0">
<input name="attr_bojeschopnost"               type="hidden" value="">
<input name="attr_bojeschopnost_mod"           type="hidden" value="">
<input name="attr_bojeschopnost_tretina_zivotu"type="hidden" value="0">
<input name="attr_bojeschopnost_mez_vyrazeni"  type="hidden" value="0">
<input name="attr_bojeschopnost_mod_vyrazeni"  type="hidden" value="0">
<input name="attr_uc"     type="hidden" value="0">
<input name="attr_oc"     type="hidden" value="0">
<input name="attr_ucopr"  type="hidden" value="0">
<input name="attr_ocopr"  type="hidden" value="0">
<input name="attr_ucutoc" type="hidden" value="0">







<script type="text/worker">
const int = score => parseInt(score, 10) || 0;

var stripstring = 
    'AAAAAAACEEEEIIII'+
    'DNOOOOO.OUUUUY..'+
    'aaaaaaaceeeeiiii'+
    'dnooooo.ouuuuy.y'+
    'AaAaAaCcCcCcCcDd'+
    'DdEeEeEeEeEeGgGg'+
    'GgGgHhHhIiIiIiIi'+
    'IiIiJjKkkLlLlLlL'+
    'lJlNnNnNnnNnOoOo'+
    'OoOoRrRrRrSsSsSs'+
    'SsTtTtTtUuUuUuUu'+
    'UuUuWwYyYZzZzZz.';

function removeDia(str){
    var answer='';
    for(var i=0;i<str.length;i++){
        var ch=str[i];
        var chindex=ch.charCodeAt(0)-192;   // Index of character code in the strip string
        if(chindex>=0 && chindex<stripstring.length){
            // Character is within our table, so we can strip the accent...
            var outch=stripstring.charAt(chindex);
            // ...unless it was shown as a '.'
            if(outch!='.')ch=outch;
        }
        answer+=ch;
    }
    return answer;
}


var update_bonus = function (attr) {
    const tab_bonus = [-5,-5,-4,-4,-3,-3,-2,-2,-1,-1,0,0,0,1,1,2,2,3,3,4,4,5];
    getAttrs([attr], function(values) {
        var stat_base = int(values[attr]);
/*        console.log("hodnota "+stat_base);*/
        var _base = Math.min(21, Math.max(1, stat_base));
        var _stat_bonus = tab_bonus[_base];
        var _update = {};
        _update[attr + "_mod"] = _stat_bonus;
        _update[attr] = _base;
        setAttrs(_update);
    });
};

var update_nosnost = function () {
    getAttrs(["sil_mod"], function(v) {
        var _nosnost = 210 + 30 * ( int(v.sil_mod) + 5);
        setAttrs({ nosnost: _nosnost });
    });
};

var set_nosnost = function (sb) {
    var _nosnost = 210 + 30 * ( int(sb) + 5);
    setAttrs({ nosnost: _nosnost });
    return _nosnost;
};

var update_pohyblivost = function () {
   getAttrs(["sil_mod","obr_mod","rasa"], function(values) {
        const rasova_pohyblivost = { Barbar:12, Elf:12, Člověk:11, Kroll:11, Hobit:10, Kudůk:9, Trpaslík:8 };
        var _nosnost = set_nosnost(int(values.sil_mod));
        console.log("nosnost"+_nosnost);
        var _pohyblivost = rasova_pohyblivost[values.rasa] + int(values.obr_mod) + ( int(values.sil_mod)  * 2 );
        var _update = {};
        _update["poh_0"] = _pohyblivost;
        _update["poh_0_vaha"] = "až "+_nosnost+"mn";
        _update["poh_1"] = Math.ceil(_pohyblivost * 0.75);
        _update["poh_1_vaha"] = "až "+(_nosnost * 2)+"mn";
        _update["poh_2"] = Math.ceil(_pohyblivost * 0.5);
        _update["poh_2_vaha"] = "až "+(_nosnost * 3)+"mn";
        _update["poh_3"] = Math.ceil(_pohyblivost * 0.25);
        _update["poh_3_vaha"] = "až "+(_nosnost * 4)+"mn";
        setAttrs(_update);
    });
};

/*---------------------------Výpočet POSTREHU ----------------- */

 on("change:int change:level change:obr_mod change:rasa change:povolani", function() {
    getAttrs(["int","int_mod","rasa","povolani","level","obr_mod"], function(values) {
        var intel = int(values.int);
        var intelb = int(values.int_mod);
        var rasa = values.rasa;
        var obj_rasa = 0;
        var mech_rasa = 0;
        if( rasa == "Barbar" || rasa == "Kroll" || rasa == "Trpaslík" ) obj_rasa = 5;
        if( rasa == "Elf" || rasa == "Hobit" || rasa == "Kudůk" ) mech_rasa = 5;
        
        var lvl = int(values.level);
        var obr = int(values.obr_mod);
        var pov = values.povolani;
        var obj_zlodej = 0;
        var mech_zlodej = 0;
        var nobj_zlodej = 0;
        var nmech_zlodej = 0;
       if( pov.includes("Zloděj") ) {
            obj_zlodej = (lvl * 5) + 10 + (3 * obr);
            nobj_zlodej = obr;
            mech_zlodej = (lvl * 5) + 5 + (2 * obr);
            nmech_zlodej = obr + Math.ceil(lvl/2);
        }
        var tabobj = [39,43,47,50,54,59,63,66,70,74];
        if(pov == "Zloděj-Sicco" && lvl > 5 && lvl < 16) {
            obj_zlodej = tabobj[(lvl-6)] + (3 * obr);
            mech_zlodej = ((lvl-5) * 4) + 30 + (2 * obr);
        }
       
        setAttrs({ postreh_mech: intelb + nmech_zlodej });
        setAttrs({ postreh_obj: intelb + nobj_zlodej});
        setAttrs({ postreh_mech_hledani: Math.floor(intel/2) + mech_rasa + mech_zlodej });
        setAttrs({ postreh_obj_hledani: intel + obj_rasa + obj_zlodej });
    });
});

/*
on('ready',function()
{
    on('chat:message',function(msg){
        if(msg.type==='api' && msg.content.indexOf('!d100')===0) {
            try {
                const scriptName = 'd100';
                let result;
                let displayRolls
                let check, marginal, normal, critical;
                
                who = getObj('player',msg.playerid).get('_displayname');
                let args = msg.content.split(/\s+/);
                args.shift();
                
                if (args.length < 4) {
                    sendChat(scriptName,`/w "${who}" `+ 'Error. Not enough arguments. Format is \"!d100 checkName marginalScore normalScore criticalScore\"');
                    return;
                } else {
                    check = args[0];
                    marginal = parseInt(args[1]);
                    normal = parseInt(args[2]);
                    critical = parseInt(args[3]);
                    if (isNaN(marginal) || isNaN(normal) || isNaN(critical)) {
                        sendChat(scriptName,`/w "${who}" `+ 'Error. Non-numeric limit detected');
                        return;
                    }
                }
                
                let r = randomInteger(100);
                
                if (r < marginal) {
                    result = 'Failure';
                } else if (r < normal) {
                    result = 'Marginal Success';
                } else if (r < critical) {
                    result = 'Normal Success';
                } else {
                    result = 'Critical Success';
                }
                
                let output = `&{template:default} {{name=${check} check}} {{Roll=[[${r}]]}} {{Result=${result}}}`;
                sendChat('d100', output);
            }
            catch(err) {
              sendChat('',`/w "${who}" `+ 'Error: ' + err.message);
            }
        }
    });
});
*/
on("clicked:showpc", function(eventinfo) {
    setAttrs({npc: "0"});
});
on("clicked:shownpc", function(eventinfo) {
    setAttrs({npc: "1"});
});

on("clicked:showpc_main", function(eventinfo) {
    console.log("values 0");
    setAttrs({pc_page: "0"});
});
on("clicked:showpc_schopnosti", function(eventinfo) {
    console.log("values 1");
    setAttrs({pc_page: "1"});
});
on("clicked:showpc_vybava", function(eventinfo) {
    console.log("values 2");
    setAttrs({pc_page: "2"});
});
on("clicked:showpc_extra", function(eventinfo) {
    console.log("values 3");
    setAttrs({pc_page: "3"});
});



["sil", "int", "chr", "odl", "obr","poh","poh_0","poh_1","poh_2","poh_3"].forEach(stat => {
    on(`change:${stat}`, () => {
        update_bonus(stat);
    });
});

/*---------------------------Výpočet POHYBLIVOSTI ----------------- */

on("change:sil_mod change:obr_mod change:rasa", function() {
    update_pohyblivost();
});



/*--------- Presunuti výberu nalozeni do Statu Pohyblivosti----------------- */

on("change:nalozeni", function() {
    getAttrs(["nalozeni"], function(values) {
        var nalozeni = values.nalozeni;
        var co = "poh_" + values.nalozeni;
        getAttrs([co], function(values) {
            setAttrs({ poh: int(values[co]) });
        });
        
        if(nalozeni == 3){
            setAttrs({ pretizeni: "Naložen (-1)"});
            setAttrs({ pretizeni_mod: "-1"});
        } else {
            setAttrs({ pretizeni: ""});
            setAttrs({ pretizeni_mod: "0"});
        }
    });
});

/*---------------------------Výpočet BOJESCHOPNOSTI ----------------- */

on("change:hit_points change:odl", function() {
    getAttrs(["odl","hit_points","hit_points_max"], function(values) {
        const odolnost = int(values.odl);
        var zivotu_max = int(values.hit_points_max);
        var tretina = Math.floor(zivotu_max/3);
        var _bojeschopnost_mod = "-3";
        var vyrazeni =  Math.floor(zivotu_max/4);
        if (odolnost >= 17) {
            _bojeschopnost_mod = "0";
            vyrazeni =  1;
        } else if (odolnost >= 12) { 
            _bojeschopnost_mod = "-1";
            vyrazeni =  Math.floor(zivotu_max/8);
        } else if (odolnost >= 6) { 
            _bojeschopnost_mod = "-2";
            vyrazeni =  Math.floor(zivotu_max/6);
        }
        
        var bojeschopnost = "Mrtev (X)";
        var bojeschopnost_mod = "X";
        var zivotu = int(values.hit_points);
        if(zivotu <= 0) {
        } else if (zivotu <= vyrazeni) {
          bojeschopnost = "Vyřazen (X)";  
        } else if (zivotu <= tretina) { 
            bojeschopnost = "Zraněn ("+_bojeschopnost_mod+")";
            bojeschopnost_mod = _bojeschopnost_mod;
        } else {
            bojeschopnost = "";
            bojeschopnost_mod = "0";
        } 
        
        setAttrs({ "bojeschopnost": bojeschopnost });
        setAttrs({ "bojeschopnost_mod": bojeschopnost_mod });
        setAttrs({ "bojeschopnost_tretina_zivotu": tretina });
        setAttrs({ "bojeschopnost_mez_vyrazeni": vyrazeni });
        setAttrs({ "bojeschopnost_mod_vyrazeni": _bojeschopnost_mod });

    });
});

on("change:bojeschopnost_mod", function() {
    getAttrs(["bojeschopnost_mod","Nehybny_volba","Vyrazeny_volba"], function(values) {
        if(values.bojeschopnost_mod.includes("X")){
            setAttrs({ "Nehybny_volba": 0 }); 
            setAttrs({ "Vyrazeny_volba": 1 }); 
        } else if(values.Vyrazeny_volba == 1) setAttrs({ "Vyrazeny_volba": 0 });
    });
});

on("change:Vyrazeny_volba", function() {
    getAttrs(["Nehybny_volba","Vyrazeny_volba"], function(values) {
        if(values.Vyrazeny_volba == 1) setAttrs({ "Nehybny_volba": 0 });
    });
});

on("change:Nehybny_volba", function() {
    getAttrs(["Nehybny_volba","Vyrazeny_volba"], function(values) {
        if(values.Nehybny_volba == 1) setAttrs({ "Vyrazeny_volba": 0 });
    });
});


/* ******* OČ a UČ **********************************/

on("change:sil_mod change:obr_mod change:pretizeni_mod change:bojeschopnost_mod change:zbran change:zboj1_use change:zboj2_use change:zboj3_use change:nehybny_volba change:vyrazeny_volba change:oz_volba change:rasa", function() {
    getAttrs(["zbran"], function(values) {
        //var bonusy = values;
        var _zbran = values.zbran;
        //var exbonus = int(bonusy.bojeschopnost_bonus) + int(bonusy.pretizeni_bonus);
        getAttrs(["sil_mod","obr_mod","pretizeni_mod","bojeschopnost_mod","rasa","oz_volba","nehybny_volba","vyrazeny_volba",
            _zbran, _zbran+"_uc", _zbran+"_uto", _zbran+"_oz", _zbran+"_2h",_zbran+"_maly",_zbran+"_stredni",_zbran+"_velky",
            "zboj1_use","zboj1_stit","zboj1_oc","zboj2_use","zboj2_stit","zboj2_oc","zboj3_use","zboj3_stit","zboj3_oc"], function(values) {
//            console.log("values " + values[_zbran+"_OZ"]);
            var UC = 0;
            var UCopr = 0;
            var OCopr = 0;
            var bezZbrane = 0;
            var useStit = 0;
            var pretizeni = int(values.pretizeni_mod);
            var zTvt = 1;
            var ZRod = 0;
            var rasa = values["rasa"];
            var OZv = int(values.oz_volba);
            var Nehybny = 0;
            if(( values.nehybny_volba == 1) || ( values.bojeschopnost_mod.includes("X") &&  values.vyrazeny_volba != 1)) Nehybny = 1;
            var Vyrazeny = 0;
            if(( values.vyrazeny_volba == 1) || ( values.bojeschopnost_mod.includes("X") &&  values.nehybny_volba != 1)) Vyrazeny = 1;
            var bojeschopen = 1;
            
            if ( values.bojeschopnost_mod.includes("X") || Nehybny == 1 || Vyrazeny == 1 ) bojeschopen = 0;
            console.log(values.bojeschopnost_mod.includes("X") + " | " + Nehybny + " | " + Vyrazeny + " -> " + bojeschopen);
            
            var Zbran = [];
            if( typeof(values[_zbran]) == "undefined") { Zbran["jmeno"] = "bezejmenna";} else { Zbran["jmeno"] = values[_zbran]; };
            if( typeof(values[_zbran+"_uc"]) == "undefined") { Zbran["uc"] = "";} else { Zbran["uc"] = int(values[_zbran+"_uc"]); };
            if( typeof(values[_zbran+"_uto"]) == "undefined") { Zbran["uto"] = "";} else { Zbran["uto"] = int(values[_zbran+"_uto"]); };
            if( typeof(values[_zbran+"_oz"]) == "undefined") { Zbran["oz"] = "";} else { Zbran["oz"] = int(values[_zbran+"_oz"]); };
            if( typeof(values[_zbran+"_2h"]) == "undefined") { Zbran["h2"] = "";} else { Zbran["h2"] = int(values[_zbran+"_2h"]); };
            if( typeof(values[_zbran+"_maly"]) == "undefined") { Zbran["m"] = "";} else { Zbran["m"] = int(values[_zbran+"_maly"]); };
            if( typeof(values[_zbran+"_stredni"]) == "undefined") { Zbran["s"] = "";} else { Zbran["s"] = int(values[_zbran+"_stredni"]); };
            if( typeof(values[_zbran+"_velky"]) == "undefined") { Zbran["v"] = "";} else { Zbran["v"] = int(values[_zbran+"_velky"]); };
            Zbran["tvt"] = 1;
            

            
//              Zakladni OC/UC ***********************************
            var OC = 0;
            if(values["zboj1_use"] == 1 && values["zboj1_stit"] == 0 && typeof(values["zboj1_oc"]) != "undefined" ) OC = OC + int(values["zboj1_oc"]);
            if(values["zboj2_use"] == 1 && values["zboj2_stit"] == 0 && typeof(values["zboj2_oc"]) != "undefined" ) OC = OC + int(values["zboj2_oc"]);
            if(values["zboj3_use"] == 1 && values["zboj3_stit"] == 0 && typeof(values["zboj3_oc"]) != "undefined" ) OC = OC + int(values["zboj3_oc"]);
            OC = Math.max(1,OC);
            OC = Math.max(0,int(values.obr_mod) + OC )
            setAttrs({ "oc": OC });
            
            if(_zbran.includes("strel") && typeof(values[_zbran+"_uc"]) != "undefined"){
              UC = int(values.obr_mod) + Zbran["uc"];
              zTvt = 0;
              Zbran["tvt"] = 0;
            } else {
                UC = int(values.sil_mod);
                if(typeof(values[_zbran+"_uc"]) != "undefined") {
                   UC = UC  + Zbran["uc"];
                } else bezZbrane = 1;
            }
             
            if(bezZbrane == 0) {
                var zjmeno = removeDia(Zbran["jmeno"]).toLowerCase();
                console.log("jmeno zbrane - " + zjmeno);
                if( rasa=="Barbar"   && Zbran["uc"]==6 && Zbran["uto"]==0 && Zbran["h2"]==0 && Zbran["tvt"]==1 && Zbran["oz"]==1  && zjmeno.includes("mec bastard")) ZRod = 1;
                if( rasa=="Elf"      && Zbran["uc"]==5 && Zbran["uto"]==1 && Zbran["h2"]==1 && Zbran["tvt"]==0                    && zjmeno.includes("dlouhy luk")  ) ZRod = 1;
                if( rasa=="Člověk"   && Zbran["uc"]==5 && Zbran["uto"]==0 && Zbran["h2"]==0 && Zbran["tvt"]==1 && Zbran["oz"]==0  && zjmeno.includes("siroky mec") ) ZRod = 1;
                if( rasa=="Kroll"    && Zbran["uc"]==5 && Zbran["uto"]==4 && Zbran["h2"]==1 && Zbran["tvt"]==1 && Zbran["oz"]==-1 && zjmeno.includes("tezky kyj")  ) ZRod = 1;
                if( rasa=="Hobit"    && Zbran["uc"]==4 && Zbran["uto"]==1 && Zbran["h2"]==1 && Zbran["tvt"]==0                    && zjmeno.includes("lehka kus")  ) ZRod = 1;
                if( rasa=="Kudůk"    && Zbran["uc"]==3 && Zbran["uto"]==1 && Zbran["h2"]==0                                       && zjmeno.includes("sekera")     ) ZRod = 1;
                if( rasa=="Trpaslík" && Zbran["uc"]==4 && Zbran["uto"]==3 && Zbran["h2"]==1 && Zbran["tvt"]==1 && Zbran["oz"]==-1 && zjmeno.includes("valecna sekera")) ZRod = 1;

                UC = UC + ZRod;
            };
            
            UC = Math.max(0,UC);
            if(bojeschopen == 0) UC = "X";
            setAttrs({ "uc": UC });
          
            
//           Opravy ******************************************
            
            var Stit = 0;
            if(values["zboj1_use"] == 1 && values["zboj1_stit"] == 1 && typeof(values["zboj1_oc"]) != "undefined" ) Stit = Stit + int(values["zboj1_oc"]);
            if(values["zboj2_use"] == 1 && values["zboj2_stit"] == 1 && typeof(values["zboj2_oc"]) != "undefined" ) Stit = Stit + int(values["zboj2_oc"]);
            if(values["zboj3_use"] == 1 && values["zboj3_stit"] == 1 && typeof(values["zboj3_oc"]) != "undefined" ) Stit = Stit + int(values["zboj3_oc"]);
            
            
            if(bojeschopen == 1){
                if(Stit > 0 && Zbran["h2"] != 1){
                    useStit = 1;
                    OCopr = OCopr + Stit;
                };
                
                OCopr = OCopr + int(values["pretizeni_mod"]) + int(values["bojeschopnost_mod"]);
                
                if(OZv < 1) {
                    OCopr = OCopr + OZv; 
                } else {
                    if(Zbran["oz"] == "" && useStit == 1) {
                        OCopr = OCopr + 0;
                    } else {
                        OCopr = OCopr + int(Zbran["oz"]);
                    };
                };
            } else {
                OCopr = OCopr - int(values["obratnost_mod"]) - 5 - 3 ;
            };
            setAttrs({ "ocopr": OCopr });
            
            if(bojeschopen == 1){
                UCopr = UCopr + int(values["pretizeni_mod"]) + int(values["bojeschopnost_mod"]); 
            };
            setAttrs({ "ucopr": UCopr });
            setAttrs({ "ucutoc": Zbran["uto"] });
            
        });

    });
});

























<rolltemplate class="sheet-rolltemplate-Obrana">
    <div class="container">
        <div><h1>{{name}}</h1></div>
        <div class="arrow-container"><div class="arrow-right"></div></div>
        <div class="rowcolor"><span class="tcat">Výsledek: </span><label>{{Result}}</label></div>
     </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-Utok">
    <div class="container">
        <div><h1>{{name}}</h1></div>
        <div class="arrow-container"><div class="arrow-right"></div></div>
        <div class="rowcolor"><span class="tcat">Výsledek: </span><label>{{Result}}</label></div>
        <div class="rowcolor"><span class="tcat">Útočnost: </span><label>{{utoc}}</label></div>
     </div>
</rolltemplate>


<rolltemplate class="sheet-rolltemplate-Hledani">
    <div class="container">
        <div><h1>{{name}}</h1></div>
        <div class="arrow-container"><div class="arrow-right"></div></div>
        <div class="rowcolor"><span class="tcat">Objekty: </span><label>{{Obj}}%</label></div>
        <div class="rowcolor"><span class="tcat">Mechanismy: </span><label>{{Mech}}%</label></div>
     </div>
</rolltemplate>

</script>
