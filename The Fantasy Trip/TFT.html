<!DOCTYPE html>

<input type='hidden' class='sheet-tabstoggle' name='attr_sheetTab'  value='character'/>

<div class='sheet-character'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;'>Journal</button>
	</div>
	<div class="sheet-grid-section">
		<div class="sheet-namelvl sheet-block">
			 <span class=sheet-label>
				Name <input type=text style='width: 22em;' name="attr_cname"/>
				Title/Rank <input type=text style='width: 7em;' name="attr_title"/>
			</span>
			<span class=sheet-label>
				Age <input type=text style='width: 3em;'name="attr_age"/>
				Race <input type=text style='width: 10em;'name="attr_race"/>
				Gender <input type=text style='width: 7em;' name="attr_gender"/>
			</span>
		</div>
		<div class="sheet-stats sheet-block">
			<span>
				<span class=sheet-stat-label>ST</span>
				<input class=sheet-stat-input type=number name="attr_ST_max" value="8"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_ST" value="8"/>
				<button type=roll value="@{character_name} checks Strength, roll 3d6 [[3d6]] vs [[@{ST}]]"><span class=sheet-stat-roll>3</span></button>
				<button type=roll value="@{character_name} checks Strength, roll 4d6 [[4d6]] vs [[@{ST}]]"><span class=sheet-stat-roll>4</span></button>
			</span>
			<span>
				<span class=sheet-stat-label>DX</span>
				<input class=sheet-stat-input type=number name="attr_DX_max" value="8"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_DX" value="8"/>
				<button type=roll value="@{character_name} checks Dex, roll 3d6 [[3d6]] vs [[@{DX}]]"><span class=sheet-stat-roll>3</span></button>
				<button type=roll value="@{character_name} checks Dex, roll 4d6 [[4d6]] vs [[@{DX}]]"><span class=sheet-stat-roll>4</span></button>
			</span>
			<span>
				<span class=sheet-stat-label>IQ</span>
				<input class=sheet-stat-input type=number name="attr_IQ_max" value="8"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_IQ" value="8"/>
				<button type=roll value="@{character_name} checks IQ, roll 3d6 [[3d6]] vs [[@{IQ}]]"><span class=sheet-stat-roll>3</span></button>
				<button type=roll value="@{character_name} checks IQ, roll 4d6 [[4d6]] vs [[@{IQ}]]"><span class=sheet-stat-roll>4</span></button>
			</span>
			<span>
				<span class=sheet-stat-label>MA</span>
				<input class=sheet-stat-input type=number name="attr_MA_max" value="10"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_MA" value="10"/>
			</span>
			<span>
				<b class=sheet-label style='width: 7.5em'>Weight Carried</b>
				<input type=text style='width: 3.5em;' name="attr_weightcarried" readonly/>
			</span>
		</div>
		<div class="sheet-combat sheet-block">
			<span>
				<button type=roll value="@{character_name} takes initiative [[@{DX} &{tracker}]]"><b style='font-size: .8em;'>Initiative</b></button>
				<span class=sheet-label style='width: 1em'> </span>
				<span class=sheet-label title="Current strength due to damage and fatigue.">HP</span>
				<input type=number style='width: 3.5em;' name="attr_stcurrent" readonly/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Damage done to you.">Hits Taken</span>
				<input type=number style='width: 3.5em;' name="attr_Hits" value="0"/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Temporary damage done to you like for spellcasting.">Fatigue</span>
				<input type=number style='width: 3.5em;' name="attr_Fatigue" value="0"/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Subtracted from enemy dex when attacking you.">Minus to Hit</span>
				<input type=number style='width: 3.5em;' name=attr_minustohit value="0" readonly/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Hits blocked per attack by your armor/shields/abilities.">Hits Blocked</span>
				<input type=number style='width: 3.5em;' name=attr_totalblock value="0" readonly/>
			</span>
		</div>
		<div class="sheet-talents sheet-block">
			<label>Talents:</label>
			<span>
				<span class=sheet-label style='width: 2.5em;'> </span>
				<span class=sheet-label style='width: 10em;'>Name</span>
				<span class=sheet-label style='width: 5em;'>Cost</span>
				<span class=sheet-label style='width: 5em;'>IQ Req</span>
			</span>
			<fieldset class=repeating_talents>
				<button type=roll value="@{character_name} uses @{talentname}! Roll [[3d6]]"></button>
				<input type=text name=attr_talentname style='width: 10em;'>
				<input type=text name=attr_talentcost value="0" style='width: 5em;'>
				<input type=text name=attr_talentiq value="8" style='width: 5em;'>
			</fieldset>
		</div>
		<div class="sheet-weapons sheet-block">
		<label>Weapons:</label>
		<span>
			<span class=sheet-label style='width: 2.2em;'> </span>
			<span class=sheet-label style='width: 10em;'>Name</span>
			<span class=sheet-label style='width: 4em;'>Damage</span>
			<span class=sheet-label style='width: 3.5em;' title="Dex adjustment to hit an enemy.">To Hit</span>
			<span class=sheet-label style='width: 30em;'>Notes</span>
			<span class=sheet-label style='width: 2.5em;' title="Weight per item.">Lbs</span>
			<span class=sheet-label style='width: 1.625em;' title="Not carried, won't count as weight.">NC</span>
		</span>
		<fieldset class=repeating_weapons>
			<button type=roll value="@{character_name} Attacks with their @{weaponname}! Roll [[3d6]] vs [[@{DX} + @{weapondex}]]; Damage [[@{weapondamage}]]"></button>
			<input type=text name=attr_weaponname style='width: 10em;'>
			<input type=text name=attr_weapondamage value="1d6" style='width: 4em;'>
			<input type=text name=attr_weapondex value="" style='width: 3.5em;'>
			<input type=text name=attr_weaponnotes style='width: 30em;'>
			<input type=text name=attr_weaponwt value="" style='width: 2.5em;'>
			<input type="checkbox" name="attr_weaponnotcarried" value="1" style='width: 1.25em;'>
		</fieldset>
		</div>
		<div class="sheet-armor sheet-block">
			<label>Armor and Shields:</label>
			<span>
				<span class=sheet-label style='width: 10em;'>Name</span>
				<span class=sheet-label style='width: 4em;' title="Damage absorbed per attack.">Hits Blocked</span>
				<span class=sheet-label style='width: 4em;' title="Subtracted from opponent's Dex when they attack.">Minus to Hit</span>
				<span class=sheet-label style='width: 35em;'>Notes</span>
				<span class=sheet-label style='width: 2.5em;' title="Weight per item.">Lbs</span>
				<span class=sheet-label style='width: 1.625em;' title="Not carried, won't count as weight.">NC</span>
			</span>
			<fieldset class=repeating_armor>
				<input type=text name=attr_defensename value="" style='width: 10em;'>
				<input type=text name=attr_hitsblocked value="0" style='width: 4em;'>
				<input type=text name=attr_defenseminustohit value="0" style='width: 4em;'>
				<input type=text name=attr_defensenotes style='width: 35em;'>
				<input type=text name=attr_defensewt value="" style='width: 2.5em;'>
				<input type="checkbox" name="attr_defensenotcarried" value="1" style='width: 1.25em;'>
			</fieldset>
		</div>
		<div class="sheet-spells sheet-block">
			<label>Spells:</label>
			<span>
				<span class=sheet-label style='width: 2.5em;'> </span>
				<span class=sheet-label style='width: 10em;'>Name</span>
				<span class=sheet-label style='width: 5em;'>Damage</span>
				<span class=sheet-label style='width: 10em;'>Notes</span>
			</span>
			<fieldset class=repeating_spells>
				<button type=roll value="@{character_name} casts @{spellname}! Roll [[3d6]] vs [[@{DX}]]; Damage [[@{spelldamage}]]"></button>
				<input type=text name=attr_spellname style='width: 10em;'>
				<input type=text name=attr_spelldamage style='width: 5em;'>
				<input type=text name=attr_spellnotes style='width: 35em;'>
			</fieldset>
		</div>
		<div class="sheet-equip sheet-block">
			<label>Equipment:</label>
			<span>
				<span class=sheet-label style='width: 10em;'>Name</span>
				<span class=sheet-label style='width: 4.5em;'>Count</span>
				<span class=sheet-label style='width: 36em;'>Notes</span>
				<span class=sheet-label style='width: 2.5em;' title="Weight per item.">Lbs</span>
				<span class=sheet-label style='width: 1.625em;' title="Not carried, won't count as weight.">NC</span>
			</span>
			<fieldset class=repeating_equipment>
				<input type=text name=attr_equipmentname style='width: 10em;'>
				<input type=number name=attr_equipmentcount value="1" style='width: 4.5em;'>
				<input type=text name=attr_equipmentnotes style='width: 36em;'>
				<input type=text name=attr_equipmentweight value="" style='width: 2.5em;'>
				<input type=checkbox name=attr_equipmentnotcarried value="1" style='width: 1.25em;'>
			</fieldset>
		</div>
	</div>
</div>
<div class='sheet-journal'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; '>Journal</button>
	</div>
	<div class="sheet-grid-section-journal">
		<div class="sheet-otherspells sheet-block">
			<label>Other Spells and Talents:</label>
			<textarea style='margin: 0px 0px 0px -5px' name="attr_spells" title="Spells"></textarea>
		</div>
		<div class="sheet-notes sheet-block">
			<label>Notes:</label>
			<textarea style='margin: 0px 0px 0px -5px' name="attr_inventory" title="Notes"></textarea>
		</div>
		<div class="sheet-pointhistory sheet-block">
			<label>Experience:</label>
			<span class=sheet-label>
				Total Experience <input type=number style='width: 6em;' name="attr_experiencetotal" value="0"/>
				Spent Experience <input type=number style='width: 6em;' name="attr_experiencespent" readonly/>
				Unspent Experience <input type=number style='width: 6em;' name="attr_experienceunspent" readonly/>
			</span>
			<br>
			<span>
				<span class=sheet-label style='width: 12em;'>Ability Acquired</span>
				<span class=sheet-label style='width: 6em;'>Exp Spent</span>
				<span class=sheet-label style='width: 35em;'>Notes</span>
			</span>
			<fieldset class=repeating_exphistory>
				<input type=text name=attr_expability style='width: 12em;'>
				<input type=number name=attr_expspent style='width: 6em;'>
				<input type=text name=attr_expnotes style='width: 35em;'>
			</fieldset>
		</div>
	</div>
</div>

<script type="text/worker">

	// just concats to make a property name.
	const repeatingPropertyName = function(repName, id, itemName) {
		return `repeating_${repName}_${id}_${itemName}`;
	}

	// Safe method to get a repeating property.
	const getFloatProperty = function(v, repName, id, itemName) {
		let property = repeatingPropertyName(repName, id, itemName);
		let val = parseFloat(v[property]);
		return isNaN(val) ? 0 : val;
	}

	// Update experience spent and unspent.
	on('sheet:opened change:experiencetotal change:repeating_exphistory remove:repeating_exphistory', function() {
		getSectionIDs("exphistory", function(idarray) {
			let fieldnames = ["experiencetotal"];
			for(var i=0; i < idarray.length; i++) {
				fieldnames.push(repeatingPropertyName('exphistory', idarray[i], 'expspent'));
			}
			getAttrs(fieldnames, function(v) {
				let total = parseInt(v.experiencetotal)||0;
				let unspent = total * 2;
				for (const property in v) {
					unspent -= parseInt(v[property])||0;
				}
				setAttrs({
					experienceunspent: unspent,
					experiencespent: (total - unspent)
				})
			});
		})
	});

	// Update Hits Blocked
	on('sheet:opened change:repeating_armor remove:repeating_armor', function() {
	    getSectionIDs("armor", function(idarray) {
			let fieldnames = []
			for(var i=0; i < idarray.length; i++) {
				fieldnames.push(repeatingPropertyName('armor', idarray[i], 'hitsblocked'));
			}
			getAttrs(fieldnames, function(v) {
				let total = 0
				for (const property in v) {
					total += parseInt(v[property])||0;
				}
				setAttrs({
					totalblock: total
				})
			});
		})
	});

	// Update Minus to Hit
	on('sheet:opened change:repeating_armor remove:repeating_armor', function() {
	    getSectionIDs("armor", function(idarray) {
			let fieldnames = []
			for(var i=0; i < idarray.length; i++) {
				fieldnames.push(repeatingPropertyName('armor', idarray[i], 'defenseminustohit'));
			}
			getAttrs(fieldnames, function(v) {
				let total = 0
				for (const property in v) {
					total += parseInt(v[property])||0;
				}
				setAttrs({
					minustohit: total
				})
			});
		})
	});

	on('sheet:opened change:st change:hits change:fatigue', function() {
		getAttrs(['st', 'hits', 'fatigue'], function(v) {
			let hitpoints = v.st - v.hits - v.fatigue;
			setAttrs({
				stcurrent: hitpoints
			});
		});
	});

	// Update weight carried.
	on('sheet:opened '
		+ 'change:repeating_weapons remove:repeating_weapons '
		+ 'change:repeating_armor remove:repeating_armor '
		+ 'change:repeating_equipment remove:repeating_equipment ', function() {
		total = 0
		totalCount = 0

		const checkAndSet = function()
		{
			++totalCount;
			if (totalCount == 3) {
				setAttrs({
					weightcarried: total
				});
			}
		}

		// to compute the total we need the object,
		// the ids, the repName, and various itemnames.
		const computeTotal = function(v, idarray, repName, weightName, countName, notCarriedName) {
			for(var i=0; i < idarray.length; i++) {
				let id = idarray[i]
				let value = getFloatProperty(v, repName, id, weightName);
				if (countName) {
					value *= getFloatProperty(v, repName, id, countName);
				}
				if (notCarriedName) {
					let notCarried = getFloatProperty(v, repName, id, notCarriedName);
					value *= (1.0 - notCarried);
				}
				total += value;
			}
			checkAndSet();
		}

		//e.g: "weapons" and "weaponwt"
		const grabIds = function(idarray, repName, weightName, countName, notCarriedName) {
			let attrs = [];
			for(var i=0; i < idarray.length; i++) {
				let id = idarray[i];
				attrs.push(repeatingPropertyName(repName, id, weightName));
				if (countName) {
					attrs.push(repeatingPropertyName(repName, id, countName));
				}
				if (notCarriedName) {
				    let propertyName = repeatingPropertyName(repName, id, notCarriedName);
					attrs.push(propertyName);
				}
			}
			getAttrs(attrs, function(v) {
				computeTotal(v, idarray, repName, weightName, countName, notCarriedName);
			});
		}
		getSectionIDs("weapons", function(v) {grabIds(v, 'weapons', 'weaponwt', '', 'weaponnotcarried');});
		getSectionIDs("armor", function(v) {grabIds(v, 'armor', 'defensewt', '', 'defensenotcarried');});
		getSectionIDs("equipment", function(v) {grabIds(v, 'equipment', 'equipmentweight', 'equipmentcount', 'equipmentnotcarried');});
	});

	const buttonlist = ["character","journal"];
	buttonlist.forEach(button => {
		on(`clicked:${button}`, function() {
			setAttrs({
				sheetTab: button
			});
		});
	});
</script>
