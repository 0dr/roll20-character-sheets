<!DOCTYPE html>

<input type='hidden' class='sheet-tabstoggle' name='attr_sheetTab'  value='character'  />

<div class='sheet-character'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;'>Journal</button>
	</div>
	<div class="sheet-grid-section">
		<div class="sheet-namelvl sheet-block">
			<label>Name:</label>
			<input type=text style='width: 27em;' name="attr_cname"/>
		</div>
		<div class="sheet-stats sheet-block">
			<label>Attributes:</label>
			<span>
				<b style='display: inline-block; width: 1.6em;'>ST</b>
				<input type=number style='width: 3.5em;' name="attr_ST_max" value="8"/>
				<b style='display: inline-block; width: 2em;'>Adj</b>
				<input type=number style='width: 3.5em;' name="attr_ST" value="8"/>
				<button type=roll value="/roll 3d6"><b style='font-size: .7em;'>3</b></button>
				<button type=roll value="/roll 4d6"><b style='font-size: .7em;'>4</b></button >
				</span>
			<span>
				<b style='display: inline-block; width: 1.6em;'>DX</b>
				<input type=number style='width: 3.5em;' name="attr_DX_max" value="8"/>
				<b style='display: inline-block; width: 2em;'>Adj</b>
				<input type=number style='width: 3.5em;' name="attr_DX" value="8"/>
				<button type=roll value="/roll 3d6"><b style='font-size: .7em;'>3</b></button>
				<button type=roll value="/roll 4d6"><b style='font-size: .7em;'>4</b></button>
			</span>
			<span>
				<b style='display: inline-block; width: 1.6em;'>IQ</b>
				<input type=number style='width: 3.5em;' name="attr_IQ_max" value="8"/>
				<b style='display: inline-block; width: 2em;'>Adj</b>
				<input type=number style='width: 3.5em;' name="attr_IQ" value="8"/>
				<button type=roll value="/roll 3d6"><b style='font-size: .7em;'>3</b></button>
				<button type=roll value="/roll 4d6"><b style='font-size: .7em;'>4</b></button>
			</span>
			<span>
				<b style='display: inline-block; width: 1.6em;'>MA</b>
				<input type=number style='width: 3.5em;' name="attr_MA_max" value="10"/>
				<b style='display: inline-block; width: 2em;'>Adj</b>
				<input type=number style='width: 3.5em;' name="attr_MA" value="10"/>
			</span>
			<span>
				<b style='display: inline-block; width: 7.5em'>Weight Carried</b>
				<input type=text style='width: 3.5em;' name="attr_carriedweight" value="0"/>
			</span>
		</div>
		<div class="sheet-combat sheet-block">
			<label>Combat:</label>
			<span>
				<button type=roll value="/roll @{DX} &{tracker}"><b style='font-size: .7em;'>Initiative</b></button>
			</span>
			<span>
				<b style='display: inline-block; width: 7em;'>Hits Taken</b>
				<input type=number style='width: 3.5em;' name="attr_Hits" value="0"/>
			</span>
			<span>
				<b style='display: inline-block; width: 7em;'>Fatigue</b>
				<input type=number style='width: 3.5em;' name="attr_Fatigue" value="0"/>
			</span>
			<span>
				<b style='display: inline-block; width: 7em;'>Minus to Hit</b>
				<input type=number style='width: 3.5em;' name=attr_minustohit value="0" />
			</span>
			<span>
				<b style='display: inline-block; width: 7em;'>Hits Blocked</b>
				<input type=number style='width: 3.5em;' name=attr_totalblock value="0" />
			</span>
		</div>
		<div class="sheet-talents sheet-block">
			<label>Talents:</label>
			<span>
				<b style='display: inline-block; width: 2.5em;'> </b>
				<b style='display: inline-block; width: 10em;'>Name</b>
				<b style='display: inline-block; width: 5em;'>Cost</b>
				<b style='display: inline-block; width: 5em;'>IQ Req</b>
			</span>
			<fieldset class=repeating_talents>
				<button type=roll value="@{character_name} uses @{talentname}! Roll [[3d6]]"></button>
				<input type=text name=attr_talentname style='width: 10em;'>
				<input type=text name=attr_talentcost value="0" style='width: 5em;'>
				<input type=text name=attr_talentiq value="8" style='width: 5em;'>
			</fieldset>
		</div>
		<div class="sheet-weapons sheet-block">
		<label>Weapons:</label>
		<span>
			<b style='display: inline-block; width: 2.5em;'> </b>
			<b style='display: inline-block; width: 10em;'>Name</b>
			<b style='display: inline-block; width: 4em;'>Damage</b>
			<b style='display: inline-block; width: 4em;'>Dex Adj</b>
			<b style='display: inline-block; width: 2.5em;'>Lbs</b>
			<b style='display: inline-block; width: 10em;'>Notes</b>
		</span>
		<fieldset class=repeating_weapons>
			<button type=roll value="@{character_name} Attacks with their @{weaponname}! Roll [[3d6]] vs [[@{DX} + @{weapondex}]]; Damage [[@{weapondamage}]]"></button>
			<input type=text name=attr_weaponname style='width: 10em;'>
			<input type=text name=attr_weapondamage value="1d6" style='width: 4em;'>
			<input type=text name=attr_weapondex value="" style='width: 4em;'>
			<input type=text name=attr_weaponwt value="" style='width: 2.5em;'>
			<input type=text name=attr_weaponnotes  style='width: 30em;'>
		</fieldset>
		</div>
		<div class="sheet-armor sheet-block">
			<label>Armor and Shields:</label>
			<span>
				<b style='display: inline-block; width: 10em;'>Name</b>
				<b style='display: inline-block; width: 5em;'>Hits Blocked</b>
				<b style='display: inline-block; width: 2.5em;'>Lbs</b>
				<b style='display: inline-block; width: 10em;'>Notes</b>
			</span>
			<fieldset class=repeating_armor>
				<input type=text name=attr_defensename value="" style='width: 10em;'>
				<input type=text name=attr_hitsblocked value="0" style='width: 5em;'>
				<input type=text name=attr_defensewt value="" style='width: 2.5em;'>
				<input type=text name=attr_defensenotes style='width: 35em;'>
			</fieldset>
		</div>
		<div class="sheet-spells sheet-block">
			<label>Spells:</label>
			<span>
				<b style='display: inline-block; width: 2.5em;'> </b>
				<b style='display: inline-block; width: 10em;'>Name</b>
				<b style='display: inline-block; width: 5em;'>Damage</b>
				<b style='display: inline-block; width: 10em;'>Notes</b>
			</span>
			<fieldset class=repeating_spells>
				<button type=roll value="@{character_name} casts @{spellname}! Roll [[3d6]] vs [[@{DX}]]; Damage [[@{spelldamage}]]"></button>
				<input type=text name=attr_spellname style='width: 10em;'>
				<input type=text name=attr_spelldamage style='width: 5em;'>
				<input type=text name=attr_spellnotes style='width: 35em;'>
			</fieldset>
		</div>
		<div class="sheet-equip sheet-block">
			<label>Equipment:</label>
			<span>
				<b style='display: inline-block; width: 10em;'>Name</b>
				<b style='display: inline-block; width: 2.5em;'>Lbs</b>
				<b style='display: inline-block; width: 10em;'>Notes</b>
			</span>
			<fieldset class=repeating_equipment>
				<input type=text name=attr_equipmentname style='width: 10em;'>
				<input type=text name=attr_equipmentweight value="" style='width: 2.5em;'>
				<input type=text name=attr_equipmentnotes style='width: 40em;'>
			</fieldset>
		</div>
	</div>
</div>
<div class='sheet-journal'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; '>Journal</button>
	</div>
	<div class="sheet-grid-section-journal">
		<div class="sheet-otherspells sheet-block">
			<label>Other Spells and Talents:</label>
			<textarea style='margin: 0px 0px 0px -5px' name="attr_spells" title="Spells"></textarea>
		</div>
		<div class="sheet-notes sheet-block">
			<label>Notes:</label>
			<textarea style='margin: 0px 0px 0px -5px' name="attr_inventory" title="Notes"></textarea>
		</div>
		<div class="sheet-pointhistory sheet-block">
			<label>Experience:</label>
			<span>
				<b>Total Experience</b>
				<input type=number style='width: 6em;' name="attr_experiencetotal" value="0"/>
				<b>Spent Experience</b>
				<input type=number style='width: 6em;' name="attr_experiencespent" readonly/>
				<b>Unspent Experience</b>
				<input type=number style='width: 6em;' name="attr_experienceunspent" readonly/>
			</span>
			<br>
			<span>
				<b style='display: inline-block; width: 12em;'>Ability Acquired</b>
				<b style='display: inline-block; width: 6em;'>Exp Spent</b>
				<b style='display: inline-block; width: 35em;'>Notes</b>
			</span>
			<fieldset class=repeating_exphistory>
				<input type=text name=attr_expabiity style='width: 12em;'>
				<input type=number name=attr_expspent style='width: 6em;'>
				<input type=text name=attr_expnotes style='width: 35em;'>
			</fieldset>
		</div>
	</div>
</div>

<script type="text/worker">

	/* ===== PARAMETERS ==========
	destinations = the name of the attribute that stores the total quantity
			can be a single attribute, or an array: ['total_cost', 'total_weight']
			If more than one, the matching fields must be in the same order.
		section = name of repeating fieldset, without the repeating_
		fields = the name of the attribute field to be summed
				destination and fields both can be a single attribute: 'weight'
				or an array of attributes: ['weight','number','equipped']
	*/
	const repeatingSum = (destinations, section, fields) => {
		if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
		if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
		getSectionIDs(`repeating_${section}`, idArray => {
			const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
			getAttrs([...attrArray], v => {
					const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
					const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
					const output = {};
					destinations.forEach((destination, index) => {
						output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
					});
					setAttrs(output);
			});
		});
	}

	on('sheet:opened change:experiencetotal change:repeating_exphistory:expspent remove:repeating_exphistory', function() {
	repeatingSum("experiencespent","exphistory","expspent");
		getAttrs(["experiencetotal","experiencespent"], function(v) {
			let total = parseInt(v.experiencetotal)||0;
			let spent = parseInt(v.experiencespent)||0;
			let unspent = total - spent;
			setAttrs({
					experienceunspent: unspent
			})
		});
	});

	const buttonlist = ["character","journal"];
	buttonlist.forEach(button => {
		on(`clicked:${button}`, function() {
			setAttrs({
				sheetTab: button
			});
		});
	});
</script>
