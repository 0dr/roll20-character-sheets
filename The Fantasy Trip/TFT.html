<!DOCTYPE html>

<input type='hidden' class='sheet-tabstoggle' name='attr_sheetTab'  value='character'/>

<div class='sheet-character'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;'>Journal</button>
	</div>
	<div class="sheet-grid-section">
		<div class="sheet-namelvl sheet-block">
			<span class=sheet-label>
				Name <input type=text style='width: 22em;' name="attr_cname"/>
				&nbsp
				Age <input type=text style='width: 3em;'name="attr_age"/>
			</span>
			<span class=sheet-label>
				Title/Rank <input type=text style='width: 7em;' name="attr_title"/>
				&nbsp
				Race <input type=text style='width: 8em;'name="attr_race"/>
				&nbsp
				Gender <input type=text style='width: 5em;' name="attr_gender"/>
			</span>
		</div>
		<div class="sheet-stats sheet-block">
			<span>
				<span class=sheet-stat-label>ST</span>
				<input class=sheet-stat-input type=number name="attr_ST_max" value="8"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_ST" value="8"/>
				<button class=sheet-dice-button type="action" name="act_st_check3">t<span class=sheet-stat-roll>3</span></button>
				<button class=sheet-dice-button type="action" name="act_st_check4">t<span class=sheet-stat-roll>4</span></button>
			</span>
			<span>
				<span class=sheet-stat-label>DX</span>
				<input class=sheet-stat-input type=number name="attr_DX_max" value="8"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_DX" value="8"/>
				<button class=sheet-dice-button type="action" name="act_dx_check3">t<span class=sheet-stat-roll>3</span></button>
				<button class=sheet-dice-button type="action" name="act_dx_check4">t<span class=sheet-stat-roll>4</span></button>
			</span>
			<span>
				<span class=sheet-stat-label>IQ</span>
				<input class=sheet-stat-input type=number name="attr_IQ_max" value="8"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_IQ" value="8"/>
				<button class=sheet-dice-button type="action" name="act_iq_check3">t<span class=sheet-stat-roll>3</span></button>
				<button class=sheet-dice-button type="action" name="act_iq_check4">t<span class=sheet-stat-roll>4</span></button>
			</span>
			<span>
				<span class=sheet-stat-label>MA</span>
				<input class=sheet-stat-input type=number name="attr_MA_max" value="10"/>
				<span class=sheet-stat-label2>Adj</span>
				<input class=sheet-stat-input type=number name="attr_MA" value="10"/>
			</span>
			<span>
				<span class=sheet-label style='width: 8em'>Weight Carried</span>
				<span class=sheet-label name="attr_weightcarried"></span>
			</span>
		</div>
		<div class="sheet-combat sheet-block">
			<span>
				<button type=roll value="@{character_name} takes initiative [[@{DX} &{tracker}]]"><b style='font-size: .8em;'>Initiative</b></button>
				&nbsp
				<span class=sheet-label title="Current strength due to damage and fatigue.">HP</span>
				<span class=sheet-label name="attr_stcurrent"/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Damage done to you.">Hits Taken</span>
				<input type=number style='width: 3.5em;' name="attr_Hits" value="0"/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Temporary damage done to you like for spellcasting.">Fatigue</span>
				<input type=number style='width: 3.5em;' name="attr_Fatigue" value="0"/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Subtracted from enemy dex when attacking you.">Minus to Hit</span>
				<span class=sheet-label name="attr_minustohit"/>
			</span>
			<span>
				<span class=sheet-label style='width: 7em;' title="Hits blocked per attack by your armor/shields/abilities.">Hits Blocked</span>
				<span class=sheet-label name="attr_totalblock"/>
			</span>
		</div>
		<div class="sheet-talents sheet-block">
			<label>Talents:</label>
			<span>
				<span class=sheet-label style='width: 2.3em;'> </span>
				<span class=sheet-label style='width: 10.5em;'>Name</span>
				<span class=sheet-label style='width: 3em;' title='IQ paid for this talent.'>Cost</span>
				<span class=sheet-label style='width: 3.5em;'>IQ Req</span>
			</span>
			<fieldset class=repeating_talents>
				<button type=roll value="@{character_name} uses @{talentname}! Roll [[3d6]]"></button>
				<input type=text name=attr_talentname style='width: 10.5em;'>
				<input type=text name=attr_talentcost value="0" style='width: 3em;'>
				<input type=text name=attr_talentiq value="8" style='width: 3em;'>
			</fieldset>
		</div>
		<div class="sheet-weapons sheet-block">
		<label>Weapons:</label>
		<span>
			<span class=sheet-label style='width: 2.2em;'> </span>
			<span class=sheet-label style='width: 10em;'>Name</span>
			<span class=sheet-label style='width: 4em;'>Damage</span>
			<span class=sheet-label style='width: 3.5em;' title="Dex adjustment to hit an enemy.">To Hit</span>
			<span class=sheet-label style='width: 30em;'>Notes</span>
			<span class=sheet-label style='width: 2.5em;' title="Weight per item.">Lbs</span>
			<span class=sheet-label style='width: 1.625em;' title="Not carried, won't count as weight.">NC</span>
		</span>
		<fieldset class=repeating_weapons>
			<button type=roll value="@{character_name} Attacks with their @{weaponname}! Roll [[3d6]] vs [[@{DX} + @{weapondex}]]; Damage [[@{weapondamage}]]"></button>
			<input type=text name=attr_weaponname style='width: 10em;'>
			<input type=text name=attr_weapondamage value="1d6" style='width: 4em;'>
			<input type=text name=attr_weapondex value="" style='width: 3.5em;'>
			<input type=text name=attr_weaponnotes style='width: 30em;'>
			<input type=text name=attr_weaponwt value="" style='width: 2.5em;'>
			<input type="checkbox" name="attr_weaponnotcarried" value="1" style='width: 1.25em;'>
		</fieldset>
		</div>
		<div class="sheet-armor sheet-block">
			<label>Armor and Shields:</label>
			<span>
				<span class=sheet-label style='width: 10em;'>Name</span>
				<span class=sheet-label style='width: 4em;' title="Damage absorbed per attack.">Hits Blocked</span>
				<span class=sheet-label style='width: 4em;' title="Subtracted from opponent's Dex when they attack.">Minus to Hit</span>
				<span class=sheet-label style='width: 35em;'>Notes</span>
				<span class=sheet-label style='width: 2.5em;' title="Weight per item.">Lbs</span>
				<span class=sheet-label style='width: 1.625em;' title="Not carried, won't count as weight.">NC</span>
			</span>
			<fieldset class=repeating_armor>
				<input type=text name=attr_defensename value="" style='width: 10em;'>
				<input type=text name=attr_hitsblocked value="0" style='width: 4em;'>
				<input type=text name=attr_defenseminustohit value="0" style='width: 4em;'>
				<input type=text name=attr_defensenotes style='width: 35em;'>
				<input type=text name=attr_defensewt value="" style='width: 2.5em;'>
				<input type="checkbox" name="attr_defensenotcarried" value="1" style='width: 1.25em;'>
			</fieldset>
		</div>
		<div class="sheet-spells sheet-block">
			<label>Spells:</label>
			<span>
				<span class=sheet-label style='width: 2.5em;'> </span>
				<span class=sheet-label style='width: 10em;'>Name</span>
				<span class=sheet-label style='width: 5em;'>Damage</span>
				<span class=sheet-label style='width: 3em;' title='IQ paid for this spell.'>Cost</span>
				<span class=sheet-label style='width: 10em;'>Notes</span>
			</span>
			<fieldset class=repeating_spells>
				<button type=roll value="@{character_name} casts @{spellname}! Roll [[3d6]] vs [[@{DX}]]; Damage [[@{spelldamage}]]"></button>
				<input type=text name=attr_spellname style='width: 10em;'>
				<input type=text name=attr_spelldamage style='width: 5em;'>
				<input type=text name=attr_spellcost value="0" style='width: 3em;'>
				<input type=text name=attr_spellnotes style='width: 35em;'>
			</fieldset>
		</div>
		<div class="sheet-equip sheet-block">
			<label>Equipment:</label>
			<span>
				<span class=sheet-label style='width: 10em;'>Name</span>
				<span class=sheet-label style='width: 4.5em;'>Count</span>
				<span class=sheet-label style='width: 36em;'>Notes</span>
				<span class=sheet-label style='width: 2.5em;' title="Weight per item.">Lbs</span>
				<span class=sheet-label style='width: 1.625em;' title="Not carried, won't count as weight.">NC</span>
			</span>
			<fieldset class=repeating_equipment>
				<input type=text name=attr_equipmentname style='width: 10em;'>
				<input type=number name=attr_equipmentcount value="1" style='width: 4.5em;'>
				<input type=text name=attr_equipmentnotes style='width: 36em;'>
				<input type=text name=attr_equipmentweight value="" style='width: 2.5em;'>
				<input type=checkbox name=attr_equipmentnotcarried value="1" style='width: 1.25em;'>
			</fieldset>
		</div>
	</div>
</div>
<div class='sheet-journal'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; '>Journal</button>
	</div>
	<div class="sheet-grid-section-journal">
		<div class="sheet-otherspells sheet-block">
			<label>Other Spells and Talents:</label>
			<textarea style='margin: 0px 0px 0px -5px' name="attr_spells" title="Spells"></textarea>
		</div>
		<div class="sheet-notes sheet-block">
			<label>Notes:</label>
			<textarea style='margin: 0px 0px 0px -5px' name="attr_inventory" title="Notes"></textarea>
		</div>
		<div class="sheet-pointhistory sheet-block">
			<label>Experience:</label>
			<span class=sheet-label>
				Total Experience <input type=number style='width: 6em;' name="attr_experiencetotal" value="0"/>
				&nbsp
				<span class=sheet-label>Spent Experience: <span name="attr_experiencespent"/></span>
				&nbsp
				<span class=sheet-label>Unspent Experience: <span name="attr_experienceunspent"/></span>
				&nbsp
				<span class=sheet-label title="IQ minus spell and talent costs.">Unspent IQ: <span name="attr_iqunspent"/></span>
			</span>
			<br>
			<span>
				<span class=sheet-label style='width: 12em;'>Ability Acquired</span>
				<span class=sheet-label style='width: 6em;'>Exp Spent</span>
				<span class=sheet-label style='width: 35em;'>Notes</span>
			</span>
			<fieldset class=repeating_exphistory>
				<input type=text name=attr_expability style='width: 12em;'>
				<input type=number name=attr_expspent style='width: 6em;'>
				<input type=text name=attr_expnotes style='width: 35em;'>
			</fieldset>
		</div>
	</div>
</div>

<rolltemplate class="sheet-rolltemplate-stat-check3">
    <div class="sheet-template-container">
        <h4>{{character_name}} makes {{stat_a}} {{stat_name}} check.</h4>
        <div class="sheet-results">
            <h4><span class=sheet-rolltemplate-stat-check-dice>{{computed::roll1}}</span> = {{roll1}} vs {{stat}}<h4>
            <h4>
            {{#rollTotal() roll1 18}}
                 <span class=sheet-check-failure>Critical Failure!!</span>
            {{/rollTotal() roll1 18}}
            {{#rollTotal() roll1 17}}
                 <span class=sheet-check-failure>Critical Failure!</span>
            {{/rollTotal() roll1 17}}
            {{#rollTotal() roll1 16}}
                 <span class=sheet-check-failure>Automatic Failure!</span>
            {{/rollTotal() roll1 16}}
            {{#rollTotal() roll1 3}}
                 <span class=sheet-check-success>Critical Success!!</span>
            {{/rollTotal() roll1 3}}
            {{#rollTotal() roll1 4}}
                 <span class=sheet-check-success>Critical Success!</span>
            {{/rollTotal() roll1 4}}
            {{#rollTotal() roll1 5}}
                 <span class=sheet-check-success>Automatic Success!</span>
            {{/rollTotal() roll1 5}}
            {{#rollBetween() roll1 6 15}}
                {{#^rollGreater() roll1 stat}}
                     <span style='color:green'>Success!</span>
                {{/^rollGreater() roll1 stat}}
                {{#rollGreater() roll1 stat}}
                     <span style='color:red'>Failure!</span>
                {{/rollGreater() roll1 stat}}
            {{/rollBetween() roll1 6 15}}
            </h4>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-stat-check4">
    <div class="sheet-template-container">
        <h4>{{character_name}} makes {{stat_a}} {{stat_name}} check.</h4>
        <div class="sheet-results">
            <h4><span class=sheet-rolltemplate-stat-check-dice>{{computed::roll1}}</span> = {{roll1}} vs {{stat}}<h4>
            <h4>
            {{#rollTotal() roll1 24}}
                 <span style='color:red'>Critical Failure!!!!</span>
            {{/rollTotal() roll1 24}}
            {{#rollTotal() roll1 23}}
                 <span style='color:red'>Critical Failure!!!</span>
            {{/rollTotal() roll1 23}}
            {{#rollTotal() roll1 22}}
                 <span style='color:red'>Critical Failure!!</span>
            {{/rollTotal() roll1 22}}
            {{#rollTotal() roll1 21}}
                 <span style='color:red'>Critical Failure!</span>
            {{/rollTotal() roll1 21}}
            {{#rollTotal() roll1 20}}
                 <span style='color:red'>Automatic Failure!</span>
            {{/rollTotal() roll1 20}}
            {{#rollTotal() roll1 4}}
                 <span style='color:green'>Critical Success!!!!</span>
            {{/rollTotal() roll1 4}}
            {{#rollTotal() roll1 5}}
                 <span style='color:green'>Critical Success!!!</span>
            {{/rollTotal() roll1 5}}
            {{#rollTotal() roll1 6}}
                 <span style='color:green'>Critical Success!!</span>
            {{/rollTotal() roll1 6}}
            {{#rollTotal() roll1 7}}
                 <span style='color:green'>Critical Success!</span>
            {{/rollTotal() roll1 7}}
            {{#rollTotal() roll1 8}}
                 <span style='color:green'>Automatic Success!</span>
            {{/rollTotal() roll1 8}}
            {{#rollBetween() roll1 7 19}}
                {{#^rollGreater() roll1 stat}}
                     <span style='color:green'>Success!</span>
                {{/^rollGreater() roll1 stat}}
                {{#rollGreater() roll1 stat}}
                     <span style='color:red'>Failure!</span>
                {{/rollGreater() roll1 stat}}
            {{/rollBetween() roll1 7 19}}
            </h4>
        </div>
    </div>
</rolltemplate>


<script type="text/worker">

    const diceArrayToString = function(rolls) {
        let diceString = '';
        for (i = 0; i < rolls.length; ++i) {
            let roll = rolls[i];
            if (roll == 1) diceString += 'a';
            else if (roll == 2) diceString += 'b';
            else if (roll == 3) diceString += 'c';
            else if (roll == 4) diceString += 'd';
            else if (roll == 5) diceString += 'e';
            else diceString += 'f';
        }
        return diceString;
    }

    const finishRollWithDiceString = function(rolls, rollId) {
        let diceString = diceArrayToString(rolls);
        finishRoll(
            rollId,
            {
                roll1: diceString
            }
        );
    }
    // do the roll check and compute the dice string.
    const doRollWithDiceString = function(macro) {
        macro += ' {{character_name=@{cname}}}';
        startRoll(macro, (results) => {
            finishRollWithDiceString(results.results.roll1.dice, results.rollId);
        });
    }

    on('clicked:st_check3', (info) => {
        doRollWithDiceString("&{template:stat-check3} {{stat_a=a}} {{stat_name=strength}} {{stat=[[@{st}]]}} {{roll1=[[3d6]]}}");
    });
    on('clicked:st_check4', (info) => {
        doRollWithDiceString("&{template:stat-check4} {{stat_a=a}} {{stat_name=strength}} {{stat=[[@{st}]]}} {{roll1=[[4d6]]}}");
    });
    on('clicked:dx_check3', (info) => {
        doRollWithDiceString("&{template:stat-check3} {{stat_a=a}} {{stat_name=dexterity}} {{stat=[[@{dx}]]}} {{roll1=[[3d6]]}}");
    });
    on('clicked:dx_check4', (info) => {
        doRollWithDiceString("&{template:stat-check4} {{stat_a=a}} {{stat_name=dexterity}} {{stat=[[@{dx}]]}} {{roll1=[[4d6]]}}");
    });
    on('clicked:iq_check3', (info) => {
        doRollWithDiceString("&{template:stat-check3} {{stat_a=an}} {{stat_name=IQ}} {{stat=[[@{iq}]]}} {{roll1=[[3d6]]}}");
    });
    on('clicked:iq_check4', (info) => {
        doRollWithDiceString("&{template:stat-check4} {{stat_a=an}} {{stat_name=IQ}} {{stat=[[@{iq}]]}} {{roll1=[[4d6]]}}");
    });

</script>


<script type="text/worker">

	// just concats to make a property name.
	const repeatingPropertyName = function(repName, id, itemName) {
		return `repeating_${repName}_${id}_${itemName}`;
	}

	// Safe method to get a repeating property.
	const getFloatProperty = function(v, repName, id, itemName) {
		let property = repeatingPropertyName(repName, id, itemName);
		let val = parseFloat(v[property]);
		return isNaN(val) ? 0 : val;
	}

	// to compute the total we need the object,
	// the ids, the repName, and various itemnames.
	const computeRepeatingTotal = function(v, idarray, repName, weightName, countName, notCarriedName) {
	    let total = 0
		for(var i=0; i < idarray.length; i++) {
			let id = idarray[i]
			let value = getFloatProperty(v, repName, id, weightName);
			if (countName) {
				value *= getFloatProperty(v, repName, id, countName);
			}
			if (notCarriedName) {
				let notCarried = getFloatProperty(v, repName, id, notCarriedName);
				value *= (1.0 - notCarried);
			}
			total += value;
		}
		return total;
	}

	// Update experience spent and unspent.
	on('sheet:opened change:experiencetotal change:repeating_exphistory remove:repeating_exphistory', function() {
		getSectionIDs("exphistory", function(idarray) {
			let fieldnames = ["experiencetotal"];
			for(var i=0; i < idarray.length; i++) {
				fieldnames.push(repeatingPropertyName('exphistory', idarray[i], 'expspent'));
			}
			getAttrs(fieldnames, function(v) {
				let total = parseInt(v.experiencetotal)||0;
				let unspent = total * 2;
				for (const property in v) {
					unspent -= parseInt(v[property])||0;
				}
				setAttrs({
					experienceunspent: unspent,
					experiencespent: (total - unspent)
				})
			});
		})
	});

	// Update Hits Blocked
	on('sheet:opened change:repeating_armor remove:repeating_armor', function() {
	    getSectionIDs("armor", function(idarray) {
			let fieldnames = []
			for(var i=0; i < idarray.length; i++) {
				fieldnames.push(repeatingPropertyName('armor', idarray[i], 'hitsblocked'));
			}
			getAttrs(fieldnames, function(v) {
				let total = 0
				for (const property in v) {
					total += parseInt(v[property])||0;
				}
				setAttrs({
					totalblock: total
				})
			});
		})
	});

	// Update Minus to Hit
	on('sheet:opened change:repeating_armor remove:repeating_armor', function() {
	    getSectionIDs("armor", function(idarray) {
			let fieldnames = []
			for(var i=0; i < idarray.length; i++) {
				fieldnames.push(repeatingPropertyName('armor', idarray[i], 'defenseminustohit'));
			}
			getAttrs(fieldnames, function(v) {
				let total = 0
				for (const property in v) {
					total += parseInt(v[property])||0;
				}
				setAttrs({
					minustohit: total
				});
			});
		})
	});

	on('sheet:opened change:st change:hits change:fatigue', function() {
		getAttrs(['st', 'hits', 'fatigue'], function(v) {
			let hitpoints = v.st - v.hits - v.fatigue;
			setAttrs({
				stcurrent: hitpoints
			});
		});
	});

	// Update weight carried.
	on('sheet:opened '
		+ 'change:repeating_weapons remove:repeating_weapons '
		+ 'change:repeating_armor remove:repeating_armor '
		+ 'change:repeating_equipment remove:repeating_equipment ', function() {
		let total = 0
		let totalCount = 0

		let checkAndSet = function(weight)
		{
			total += weight;
			++totalCount;
			if (totalCount == 3) {
				setAttrs({
					weightcarried: total
				});
			}
		}

		//e.g: "weapons" and "weaponwt"
		let grabIds = function(idarray, repName, weightName, countName, notCarriedName) {
			let attrs = [];
			for(var i=0; i < idarray.length; i++) {
				let id = idarray[i];
				attrs.push(repeatingPropertyName(repName, id, weightName));
				if (countName) {
					attrs.push(repeatingPropertyName(repName, id, countName));
				}
				if (notCarriedName) {
				    let propertyName = repeatingPropertyName(repName, id, notCarriedName);
					attrs.push(propertyName);
				}
			}
			getAttrs(attrs, function(v) {
			    checkAndSet(computeRepeatingTotal(v, idarray, repName, weightName, countName, notCarriedName));
			});
		}

		getSectionIDs("weapons", function(v) {grabIds(v, 'weapons', 'weaponwt', '', 'weaponnotcarried');});
		getSectionIDs("armor", function(v) {grabIds(v, 'armor', 'defensewt', '', 'defensenotcarried');});
		getSectionIDs("equipment", function(v) {grabIds(v, 'equipment', 'equipmentweight', 'equipmentcount', 'equipmentnotcarried');});
	});

	// Update unspent iq points.
	on('sheet:opened '
		+ 'change:repeating_talents remove:repeating_talents '
		+ 'change:repeating_spells remove:repeating_spells '
		+ 'change:iq_max ', function() {
		let totalSpent = 0
		let totalCount = 0
		console.log('updating iq unspent', totalSpent, totalCount);

		let checkAndSet = function(spent)
		{
			totalSpent += spent;
			++totalCount;
			if (totalCount == 2) {
				getAttrs(['iq_max'], function(v) {
					let unspent = v.iq_max - totalSpent;
					setAttrs({
						iqunspent: unspent
					});
				});
			}
		}

		//e.g: "weapons" and "weaponwt"  TOOD share this and take a post function.
		let grabIds = function(idarray, repName, costName) {
			let attrs = [];
			for(var i=0; i < idarray.length; i++) {
				let id = idarray[i];
				attrs.push(repeatingPropertyName(repName, id, costName));
			}
			getAttrs(attrs, function(v) {
			    checkAndSet(computeRepeatingTotal(v, idarray, repName, costName)); // todo just pass this in...
			});
		}

		getSectionIDs("talents", function(v) {grabIds(v, 'talents', 'talentcost');});
		getSectionIDs("spells", function(v) {grabIds(v, 'spells', 'spellcost');});
	});


	const buttonlist = ["character","journal"];
	buttonlist.forEach(button => {
		on(`clicked:${button}`, function() {
			setAttrs({
				sheetTab: button
			});
		});
	});
</script>
